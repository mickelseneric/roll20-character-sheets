function BigInteger(t,e,r){null!=t&&("number"==typeof t?this.fromNumber(t,e,r):null==e&&"string"!=typeof t?this.fromString(t,256):this.fromString(t,e))}function nbi(){return new BigInteger(null)}function am1(t,e,r,n,i,s){for(;--s>=0;){var o=e*this[t++]+r[n]+i;i=Math.floor(o/67108864),r[n++]=67108863&o}return i}function am2(t,e,r,n,i,s){for(var o=32767&e,l=e>>15;--s>=0;){var a=32767&this[t],u=this[t++]>>15,p=l*a+u*o;i=((a=o*a+((32767&p)<<15)+r[n]+(1073741823&i))>>>30)+(p>>>15)+l*u+(i>>>30),r[n++]=1073741823&a}return i}function am3(t,e,r,n,i,s){for(var o=16383&e,l=e>>14;--s>=0;){var a=16383&this[t],u=this[t++]>>14,p=l*a+u*o;i=((a=o*a+((16383&p)<<14)+r[n]+i)>>28)+(p>>14)+l*u,r[n++]=268435455&a}return i}function int2char(t){return BI_RM.charAt(t)}function intAt(t,e){var r=BI_RC[t.charCodeAt(e)];return null==r?-1:r}function bnpCopyTo(t){for(var e=this.t-1;e>=0;--e)t[e]=this[e];t.t=this.t,t.s=this.s}function bnpFromInt(t){this.t=1,this.s=t<0?-1:0,t>0?this[0]=t:t<-1?this[0]=t+this.DV:this.t=0}function nbv(t){var e=nbi();return e.fromInt(t),e}function bnpFromString(t,e){var r;if(16==e)r=4;else if(8==e)r=3;else if(256==e)r=8;else if(2==e)r=1;else if(32==e)r=5;else{if(4!=e)return void this.fromRadix(t,e);r=2}this.t=0,this.s=0;for(var n=t.length,i=!1,s=0;--n>=0;){var o=8==r?255&t[n]:intAt(t,n);o<0?"-"==t.charAt(n)&&(i=!0):(i=!1,0==s?this[this.t++]=o:s+r>this.DB?(this[this.t-1]|=(o&(1<<this.DB-s)-1)<<s,this[this.t++]=o>>this.DB-s):this[this.t-1]|=o<<s,(s+=r)>=this.DB&&(s-=this.DB))}8==r&&0!=(128&t[0])&&(this.s=-1,s>0&&(this[this.t-1]|=(1<<this.DB-s)-1<<s)),this.clamp(),i&&BigInteger.ZERO.subTo(this,this)}function bnpClamp(){for(var t=this.s&this.DM;this.t>0&&this[this.t-1]==t;)--this.t}function bnToString(t){if(this.s<0)return"-"+this.negate().toString(t);var e;if(16==t)e=4;else if(8==t)e=3;else if(2==t)e=1;else if(32==t)e=5;else{if(4!=t)return this.toRadix(t);e=2}var r,n=(1<<e)-1,i=!1,s="",o=this.t,l=this.DB-o*this.DB%e;if(o-- >0)for(l<this.DB&&(r=this[o]>>l)>0&&(i=!0,s=int2char(r));o>=0;)l<e?(r=(this[o]&(1<<l)-1)<<e-l,r|=this[--o]>>(l+=this.DB-e)):(r=this[o]>>(l-=e)&n,l<=0&&(l+=this.DB,--o)),r>0&&(i=!0),i&&(s+=int2char(r));return i?s:"0"}function bnNegate(){var t=nbi();return BigInteger.ZERO.subTo(this,t),t}function bnAbs(){return this.s<0?this.negate():this}function bnCompareTo(t){var e=this.s-t.s;if(0!=e)return e;var r=this.t;if(0!=(e=r-t.t))return this.s<0?-e:e;for(;--r>=0;)if(0!=(e=this[r]-t[r]))return e;return 0}function nbits(t){var e,r=1;return 0!=(e=t>>>16)&&(t=e,r+=16),0!=(e=t>>8)&&(t=e,r+=8),0!=(e=t>>4)&&(t=e,r+=4),0!=(e=t>>2)&&(t=e,r+=2),0!=(e=t>>1)&&(t=e,r+=1),r}function bnBitLength(){return this.t<=0?0:this.DB*(this.t-1)+nbits(this[this.t-1]^this.s&this.DM)}function bnpDLShiftTo(t,e){var r;for(r=this.t-1;r>=0;--r)e[r+t]=this[r];for(r=t-1;r>=0;--r)e[r]=0;e.t=this.t+t,e.s=this.s}function bnpDRShiftTo(t,e){for(var r=t;r<this.t;++r)e[r-t]=this[r];e.t=Math.max(this.t-t,0),e.s=this.s}function bnpLShiftTo(t,e){var r,n=t%this.DB,i=this.DB-n,s=(1<<i)-1,o=Math.floor(t/this.DB),l=this.s<<n&this.DM;for(r=this.t-1;r>=0;--r)e[r+o+1]=this[r]>>i|l,l=(this[r]&s)<<n;for(r=o-1;r>=0;--r)e[r]=0;e[o]=l,e.t=this.t+o+1,e.s=this.s,e.clamp()}function bnpRShiftTo(t,e){e.s=this.s;var r=Math.floor(t/this.DB);if(r>=this.t)e.t=0;else{var n=t%this.DB,i=this.DB-n,s=(1<<n)-1;e[0]=this[r]>>n;for(var o=r+1;o<this.t;++o)e[o-r-1]|=(this[o]&s)<<i,e[o-r]=this[o]>>n;n>0&&(e[this.t-r-1]|=(this.s&s)<<i),e.t=this.t-r,e.clamp()}}function bnpSubTo(t,e){for(var r=0,n=0,i=Math.min(t.t,this.t);r<i;)n+=this[r]-t[r],e[r++]=n&this.DM,n>>=this.DB;if(t.t<this.t){for(n-=t.s;r<this.t;)n+=this[r],e[r++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;r<t.t;)n-=t[r],e[r++]=n&this.DM,n>>=this.DB;n-=t.s}e.s=n<0?-1:0,n<-1?e[r++]=this.DV+n:n>0&&(e[r++]=n),e.t=r,e.clamp()}function bnpMultiplyTo(t,e){var r=this.abs(),n=t.abs(),i=r.t;for(e.t=i+n.t;--i>=0;)e[i]=0;for(i=0;i<n.t;++i)e[i+r.t]=r.am(0,n[i],e,i,0,r.t);e.s=0,e.clamp(),this.s!=t.s&&BigInteger.ZERO.subTo(e,e)}function bnpSquareTo(t){for(var e=this.abs(),r=t.t=2*e.t;--r>=0;)t[r]=0;for(r=0;r<e.t-1;++r){var n=e.am(r,e[r],t,2*r,0,1);(t[r+e.t]+=e.am(r+1,2*e[r],t,2*r+1,n,e.t-r-1))>=e.DV&&(t[r+e.t]-=e.DV,t[r+e.t+1]=1)}t.t>0&&(t[t.t-1]+=e.am(r,e[r],t,2*r,0,1)),t.s=0,t.clamp()}function bnpDivRemTo(t,e,r){var n=t.abs();if(!(n.t<=0)){var i=this.abs();if(i.t<n.t)return null!=e&&e.fromInt(0),void(null!=r&&this.copyTo(r));null==r&&(r=nbi());var s=nbi(),o=this.s,l=t.s,a=this.DB-nbits(n[n.t-1]);a>0?(n.lShiftTo(a,s),i.lShiftTo(a,r)):(n.copyTo(s),i.copyTo(r));var u=s.t,p=s[u-1];if(0!=p){var h=p*(1<<this.F1)+(u>1?s[u-2]>>this.F2:0),c=this.FV/h,d=(1<<this.F1)/h,f=1<<this.F2,g=r.t,m=g-u,v=null==e?nbi():e;for(s.dlShiftTo(m,v),r.compareTo(v)>=0&&(r[r.t++]=1,r.subTo(v,r)),BigInteger.ONE.dlShiftTo(u,v),v.subTo(s,s);s.t<u;)s[s.t++]=0;for(;--m>=0;){var y=r[--g]==p?this.DM:Math.floor(r[g]*c+(r[g-1]+f)*d);if((r[g]+=s.am(0,y,r,m,0,u))<y)for(s.dlShiftTo(m,v),r.subTo(v,r);r[g]<--y;)r.subTo(v,r)}null!=e&&(r.drShiftTo(u,e),o!=l&&BigInteger.ZERO.subTo(e,e)),r.t=u,r.clamp(),a>0&&r.rShiftTo(a,r),o<0&&BigInteger.ZERO.subTo(r,r)}}}function bnMod(t){var e=nbi();return this.abs().divRemTo(t,null,e),this.s<0&&e.compareTo(BigInteger.ZERO)>0&&t.subTo(e,e),e}function Classic(t){this.m=t}function cConvert(t){return t.s<0||t.compareTo(this.m)>=0?t.mod(this.m):t}function cRevert(t){return t}function cReduce(t){t.divRemTo(this.m,null,t)}function cMulTo(t,e,r){t.multiplyTo(e,r),this.reduce(r)}function cSqrTo(t,e){t.squareTo(e),this.reduce(e)}function bnpInvDigit(){if(this.t<1)return 0;var t=this[0];if(0==(1&t))return 0;var e=3&t;return(e=(e=(e=(e=e*(2-(15&t)*e)&15)*(2-(255&t)*e)&255)*(2-((65535&t)*e&65535))&65535)*(2-t*e%this.DV)%this.DV)>0?this.DV-e:-e}function Montgomery(t){this.m=t,this.mp=t.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<t.DB-15)-1,this.mt2=2*t.t}function montConvert(t){var e=nbi();return t.abs().dlShiftTo(this.m.t,e),e.divRemTo(this.m,null,e),t.s<0&&e.compareTo(BigInteger.ZERO)>0&&this.m.subTo(e,e),e}function montRevert(t){var e=nbi();return t.copyTo(e),this.reduce(e),e}function montReduce(t){for(;t.t<=this.mt2;)t[t.t++]=0;for(var e=0;e<this.m.t;++e){var r=32767&t[e],n=r*this.mpl+((r*this.mph+(t[e]>>15)*this.mpl&this.um)<<15)&t.DM;for(t[r=e+this.m.t]+=this.m.am(0,n,t,e,0,this.m.t);t[r]>=t.DV;)t[r]-=t.DV,t[++r]++}t.clamp(),t.drShiftTo(this.m.t,t),t.compareTo(this.m)>=0&&t.subTo(this.m,t)}function montSqrTo(t,e){t.squareTo(e),this.reduce(e)}function montMulTo(t,e,r){t.multiplyTo(e,r),this.reduce(r)}function bnpIsEven(){return 0==(this.t>0?1&this[0]:this.s)}function bnpExp(t,e){if(t>4294967295||t<1)return BigInteger.ONE;var r=nbi(),n=nbi(),i=e.convert(this),s=nbits(t)-1;for(i.copyTo(r);--s>=0;)if(e.sqrTo(r,n),(t&1<<s)>0)e.mulTo(n,i,r);else{var o=r;r=n,n=o}return e.revert(r)}function bnModPowInt(t,e){var r;return r=t<256||e.isEven()?new Classic(e):new Montgomery(e),this.exp(t,r)}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function bnClone(){var t=nbi();return this.copyTo(t),t}function bnIntValue(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function bnByteValue(){return 0==this.t?this.s:this[0]<<24>>24}function bnShortValue(){return 0==this.t?this.s:this[0]<<16>>16}function bnpChunkSize(t){return Math.floor(Math.LN2*this.DB/Math.log(t))}function bnSigNum(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1}function bnpToRadix(t){if(null==t&&(t=10),0==this.signum()||t<2||t>36)return"0";var e=this.chunkSize(t),r=Math.pow(t,e),n=nbv(r),i=nbi(),s=nbi(),o="";for(this.divRemTo(n,i,s);i.signum()>0;)o=(r+s.intValue()).toString(t).substr(1)+o,i.divRemTo(n,i,s);return s.intValue().toString(t)+o}function bnpFromRadix(t,e){this.fromInt(0),null==e&&(e=10);for(var r=this.chunkSize(e),n=Math.pow(e,r),i=!1,s=0,o=0,l=0;l<t.length;++l){var a=intAt(t,l);a<0?"-"==t.charAt(l)&&0==this.signum()&&(i=!0):(o=e*o+a,++s>=r&&(this.dMultiply(n),this.dAddOffset(o,0),s=0,o=0))}s>0&&(this.dMultiply(Math.pow(e,s)),this.dAddOffset(o,0)),i&&BigInteger.ZERO.subTo(this,this)}function bnpFromNumber(t,e,r){if("number"==typeof e)if(t<2)this.fromInt(1);else for(this.fromNumber(t,r),this.testBit(t-1)||this.bitwiseTo(BigInteger.ONE.shiftLeft(t-1),op_or,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(e);)this.dAddOffset(2,0),this.bitLength()>t&&this.subTo(BigInteger.ONE.shiftLeft(t-1),this);else{var n=new Array,i=7&t;n.length=1+(t>>3),e.nextBytes(n),i>0?n[0]&=(1<<i)-1:n[0]=0,this.fromString(n,256)}}function bnToByteArray(){var t=this.t,e=new Array;e[0]=this.s;var r,n=this.DB-t*this.DB%8,i=0;if(t-- >0)for(n<this.DB&&(r=this[t]>>n)!=(this.s&this.DM)>>n&&(e[i++]=r|this.s<<this.DB-n);t>=0;)n<8?(r=(this[t]&(1<<n)-1)<<8-n,r|=this[--t]>>(n+=this.DB-8)):(r=this[t]>>(n-=8)&255,n<=0&&(n+=this.DB,--t)),0!=(128&r)&&(r|=-256),0==i&&(128&this.s)!=(128&r)&&++i,(i>0||r!=this.s)&&(e[i++]=r);return e}function bnEquals(t){return 0==this.compareTo(t)}function bnMin(t){return this.compareTo(t)<0?this:t}function bnMax(t){return this.compareTo(t)>0?this:t}function bnpBitwiseTo(t,e,r){var n,i,s=Math.min(t.t,this.t);for(n=0;n<s;++n)r[n]=e(this[n],t[n]);if(t.t<this.t){for(i=t.s&this.DM,n=s;n<this.t;++n)r[n]=e(this[n],i);r.t=this.t}else{for(i=this.s&this.DM,n=s;n<t.t;++n)r[n]=e(i,t[n]);r.t=t.t}r.s=e(this.s,t.s),r.clamp()}function op_and(t,e){return t&e}function bnAnd(t){var e=nbi();return this.bitwiseTo(t,op_and,e),e}function op_or(t,e){return t|e}function bnOr(t){var e=nbi();return this.bitwiseTo(t,op_or,e),e}function op_xor(t,e){return t^e}function bnXor(t){var e=nbi();return this.bitwiseTo(t,op_xor,e),e}function op_andnot(t,e){return t&~e}function bnAndNot(t){var e=nbi();return this.bitwiseTo(t,op_andnot,e),e}function bnNot(){for(var t=nbi(),e=0;e<this.t;++e)t[e]=this.DM&~this[e];return t.t=this.t,t.s=~this.s,t}function bnShiftLeft(t){var e=nbi();return t<0?this.rShiftTo(-t,e):this.lShiftTo(t,e),e}function bnShiftRight(t){var e=nbi();return t<0?this.lShiftTo(-t,e):this.rShiftTo(t,e),e}function lbit(t){if(0==t)return-1;var e=0;return 0==(65535&t)&&(t>>=16,e+=16),0==(255&t)&&(t>>=8,e+=8),0==(15&t)&&(t>>=4,e+=4),0==(3&t)&&(t>>=2,e+=2),0==(1&t)&&++e,e}function bnGetLowestSetBit(){for(var t=0;t<this.t;++t)if(0!=this[t])return t*this.DB+lbit(this[t]);return this.s<0?this.t*this.DB:-1}function cbit(t){for(var e=0;0!=t;)t&=t-1,++e;return e}function bnBitCount(){for(var t=0,e=this.s&this.DM,r=0;r<this.t;++r)t+=cbit(this[r]^e);return t}function bnTestBit(t){var e=Math.floor(t/this.DB);return e>=this.t?0!=this.s:0!=(this[e]&1<<t%this.DB)}function bnpChangeBit(t,e){var r=BigInteger.ONE.shiftLeft(t);return this.bitwiseTo(r,e,r),r}function bnSetBit(t){return this.changeBit(t,op_or)}function bnClearBit(t){return this.changeBit(t,op_andnot)}function bnFlipBit(t){return this.changeBit(t,op_xor)}function bnpAddTo(t,e){for(var r=0,n=0,i=Math.min(t.t,this.t);r<i;)n+=this[r]+t[r],e[r++]=n&this.DM,n>>=this.DB;if(t.t<this.t){for(n+=t.s;r<this.t;)n+=this[r],e[r++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;r<t.t;)n+=t[r],e[r++]=n&this.DM,n>>=this.DB;n+=t.s}e.s=n<0?-1:0,n>0?e[r++]=n:n<-1&&(e[r++]=this.DV+n),e.t=r,e.clamp()}function bnAdd(t){var e=nbi();return this.addTo(t,e),e}function bnSubtract(t){var e=nbi();return this.subTo(t,e),e}function bnMultiply(t){var e=nbi();return this.multiplyTo(t,e),e}function bnSquare(){var t=nbi();return this.squareTo(t),t}function bnDivide(t){var e=nbi();return this.divRemTo(t,e,null),e}function bnRemainder(t){var e=nbi();return this.divRemTo(t,null,e),e}function bnDivideAndRemainder(t){var e=nbi(),r=nbi();return this.divRemTo(t,e,r),new Array(e,r)}function bnpDMultiply(t){this[this.t]=this.am(0,t-1,this,0,0,this.t),++this.t,this.clamp()}function bnpDAddOffset(t,e){if(0!=t){for(;this.t<=e;)this[this.t++]=0;for(this[e]+=t;this[e]>=this.DV;)this[e]-=this.DV,++e>=this.t&&(this[this.t++]=0),++this[e]}}function NullExp(){}function nNop(t){return t}function nMulTo(t,e,r){t.multiplyTo(e,r)}function nSqrTo(t,e){t.squareTo(e)}function bnPow(t){return this.exp(t,new NullExp)}function bnpMultiplyLowerTo(t,e,r){var n,i=Math.min(this.t+t.t,e);for(r.s=0,r.t=i;i>0;)r[--i]=0;for(n=r.t-this.t;i<n;++i)r[i+this.t]=this.am(0,t[i],r,i,0,this.t);for(n=Math.min(t.t,e);i<n;++i)this.am(0,t[i],r,i,0,e-i);r.clamp()}function bnpMultiplyUpperTo(t,e,r){--e;var n=r.t=this.t+t.t-e;for(r.s=0;--n>=0;)r[n]=0;for(n=Math.max(e-this.t,0);n<t.t;++n)r[this.t+n-e]=this.am(e-n,t[n],r,0,0,this.t+n-e);r.clamp(),r.drShiftTo(1,r)}function Barrett(t){this.r2=nbi(),this.q3=nbi(),BigInteger.ONE.dlShiftTo(2*t.t,this.r2),this.mu=this.r2.divide(t),this.m=t}function barrettConvert(t){if(t.s<0||t.t>2*this.m.t)return t.mod(this.m);if(t.compareTo(this.m)<0)return t;var e=nbi();return t.copyTo(e),this.reduce(e),e}function barrettRevert(t){return t}function barrettReduce(t){for(t.drShiftTo(this.m.t-1,this.r2),t.t>this.m.t+1&&(t.t=this.m.t+1,t.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);t.compareTo(this.r2)<0;)t.dAddOffset(1,this.m.t+1);for(t.subTo(this.r2,t);t.compareTo(this.m)>=0;)t.subTo(this.m,t)}function barrettSqrTo(t,e){t.squareTo(e),this.reduce(e)}function barrettMulTo(t,e,r){t.multiplyTo(e,r),this.reduce(r)}function bnModPow(t,e){var r,n,i=t.bitLength(),s=nbv(1);if(i<=0)return s;r=i<18?1:i<48?3:i<144?4:i<768?5:6,n=i<8?new Classic(e):e.isEven()?new Barrett(e):new Montgomery(e);var o=new Array,l=3,a=r-1,u=(1<<r)-1;if(o[1]=n.convert(this),r>1){var p=nbi();for(n.sqrTo(o[1],p);l<=u;)o[l]=nbi(),n.mulTo(p,o[l-2],o[l]),l+=2}var h,c,d=t.t-1,f=!0,g=nbi();for(i=nbits(t[d])-1;d>=0;){for(i>=a?h=t[d]>>i-a&u:(h=(t[d]&(1<<i+1)-1)<<a-i,d>0&&(h|=t[d-1]>>this.DB+i-a)),l=r;0==(1&h);)h>>=1,--l;if((i-=l)<0&&(i+=this.DB,--d),f)o[h].copyTo(s),f=!1;else{for(;l>1;)n.sqrTo(s,g),n.sqrTo(g,s),l-=2;l>0?n.sqrTo(s,g):(c=s,s=g,g=c),n.mulTo(g,o[h],s)}for(;d>=0&&0==(t[d]&1<<i);)n.sqrTo(s,g),c=s,s=g,g=c,--i<0&&(i=this.DB-1,--d)}return n.revert(s)}function bnGCD(t){var e=this.s<0?this.negate():this.clone(),r=t.s<0?t.negate():t.clone();if(e.compareTo(r)<0){var n=e;e=r,r=n}var i=e.getLowestSetBit(),s=r.getLowestSetBit();if(s<0)return e;for(i<s&&(s=i),s>0&&(e.rShiftTo(s,e),r.rShiftTo(s,r));e.signum()>0;)(i=e.getLowestSetBit())>0&&e.rShiftTo(i,e),(i=r.getLowestSetBit())>0&&r.rShiftTo(i,r),e.compareTo(r)>=0?(e.subTo(r,e),e.rShiftTo(1,e)):(r.subTo(e,r),r.rShiftTo(1,r));return s>0&&r.lShiftTo(s,r),r}function bnpModInt(t){if(t<=0)return 0;var e=this.DV%t,r=this.s<0?t-1:0;if(this.t>0)if(0==e)r=this[0]%t;else for(var n=this.t-1;n>=0;--n)r=(e*r+this[n])%t;return r}function bnModInverse(t){var e=t.isEven();if(this.isEven()&&e||0==t.signum())return BigInteger.ZERO;for(var r=t.clone(),n=this.clone(),i=nbv(1),s=nbv(0),o=nbv(0),l=nbv(1);0!=r.signum();){for(;r.isEven();)r.rShiftTo(1,r),e?(i.isEven()&&s.isEven()||(i.addTo(this,i),s.subTo(t,s)),i.rShiftTo(1,i)):s.isEven()||s.subTo(t,s),s.rShiftTo(1,s);for(;n.isEven();)n.rShiftTo(1,n),e?(o.isEven()&&l.isEven()||(o.addTo(this,o),l.subTo(t,l)),o.rShiftTo(1,o)):l.isEven()||l.subTo(t,l),l.rShiftTo(1,l);r.compareTo(n)>=0?(r.subTo(n,r),e&&i.subTo(o,i),s.subTo(l,s)):(n.subTo(r,n),e&&o.subTo(i,o),l.subTo(s,l))}return 0!=n.compareTo(BigInteger.ONE)?BigInteger.ZERO:l.compareTo(t)>=0?l.subtract(t):l.signum()<0?(l.addTo(t,l),l.signum()<0?l.add(t):l):l}function bnIsProbablePrime(t){var e,r=this.abs();if(1==r.t&&r[0]<=lowprimes[lowprimes.length-1]){for(e=0;e<lowprimes.length;++e)if(r[0]==lowprimes[e])return!0;return!1}if(r.isEven())return!1;for(e=1;e<lowprimes.length;){for(var n=lowprimes[e],i=e+1;i<lowprimes.length&&n<lplim;)n*=lowprimes[i++];for(n=r.modInt(n);e<i;)if(n%lowprimes[e++]==0)return!1}return r.millerRabin(t)}function bnpMillerRabin(t){var e=this.subtract(BigInteger.ONE),r=e.getLowestSetBit();if(r<=0)return!1;var n=e.shiftRight(r);(t=t+1>>1)>lowprimes.length&&(t=lowprimes.length);for(var i=nbi(),s=0;s<t;++s){i.fromInt(lowprimes[Math.floor(Math.random()*lowprimes.length)]);var o=i.modPow(n,this);if(0!=o.compareTo(BigInteger.ONE)&&0!=o.compareTo(e)){for(var l=1;l++<r&&0!=o.compareTo(e);)if(0==(o=o.modPowInt(2,this)).compareTo(BigInteger.ONE))return!1;if(0!=o.compareTo(e))return!1}}return!0}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function parseBigInt(t,e){return new BigInteger(t,e)}function linebrk(t,e){for(var r="",n=0;n+e<t.length;)r+=t.substring(n,n+e)+"\n",n+=e;return r+t.substring(n,t.length)}function byte2Hex(t){return t<16?"0"+t.toString(16):t.toString(16)}function pkcs1pad2(t,e){if(e<t.length+11)return alert("Message too long for RSA"),null;for(var r=new Array,n=t.length-1;n>=0&&e>0;){var i=t.charCodeAt(n--);i<128?r[--e]=i:i>127&&i<2048?(r[--e]=63&i|128,r[--e]=i>>6|192):(r[--e]=63&i|128,r[--e]=i>>6&63|128,r[--e]=i>>12|224)}r[--e]=0;for(var s=new SecureRandom,o=new Array;e>2;){for(o[0]=0;0==o[0];)s.nextBytes(o);r[--e]=o[0]}return r[--e]=2,r[--e]=0,new BigInteger(r)}function oaep_mgf1_arr(t,e,r){for(var n="",i=0;n.length<e;)n+=r(String.fromCharCode.apply(String,t.concat([(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i]))),i+=1;return n}function oaep_pad(t,e,r){if(t.length+2*SHA1_SIZE+2>e)throw"Message too long for RSA";var n,i="";for(n=0;n<e-t.length-2*SHA1_SIZE-2;n+=1)i+="\0";var s=rstr_sha1("")+i+"\x01"+t,o=new Array(SHA1_SIZE);(new SecureRandom).nextBytes(o);var l=oaep_mgf1_arr(o,s.length,r||rstr_sha1),a=[];for(n=0;n<s.length;n+=1)a[n]=s.charCodeAt(n)^l.charCodeAt(n);var u=oaep_mgf1_arr(a,o.length,rstr_sha1),p=[0];for(n=0;n<o.length;n+=1)p[n+1]=o[n]^u.charCodeAt(n);return new BigInteger(p.concat(a))}function RSAKey(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function RSASetPublic(t,e){this.isPublic=!0,"string"!=typeof t?(this.n=t,this.e=e):null!=t&&null!=e&&t.length>0&&e.length>0?(this.n=parseBigInt(t,16),this.e=parseInt(e,16)):alert("Invalid RSA public key")}function RSADoPublic(t){return t.modPowInt(this.e,this.n)}function RSAEncrypt(t){var e=pkcs1pad2(t,this.n.bitLength()+7>>3);if(null==e)return null;var r=this.doPublic(e);if(null==r)return null;var n=r.toString(16);return 0==(1&n.length)?n:"0"+n}function RSAEncryptOAEP(t,e){var r=oaep_pad(t,this.n.bitLength()+7>>3,e);if(null==r)return null;var n=this.doPublic(r);if(null==n)return null;var i=n.toString(16);return 0==(1&i.length)?i:"0"+i}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function pkcs1unpad2(t,e){for(var r=t.toByteArray(),n=0;n<r.length&&0==r[n];)++n;if(r.length-n!=e-1||2!=r[n])return null;for(++n;0!=r[n];)if(++n>=r.length)return null;for(var i="";++n<r.length;){var s=255&r[n];s<128?i+=String.fromCharCode(s):s>191&&s<224?(i+=String.fromCharCode((31&s)<<6|63&r[n+1]),++n):(i+=String.fromCharCode((15&s)<<12|(63&r[n+1])<<6|63&r[n+2]),n+=2)}return i}function oaep_mgf1_str(t,e,r){for(var n="",i=0;n.length<e;)n+=r(t+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])),i+=1;return n}function oaep_unpad(t,e,r){for(t=t.toByteArray(),n=0;n<t.length;n+=1)t[n]&=255;for(;t.length<e;)t.unshift(0);if((t=String.fromCharCode.apply(String,t)).length<2*SHA1_SIZE+2)throw"Cipher too short";var n,i=t.substr(1,SHA1_SIZE),s=t.substr(SHA1_SIZE+1),o=oaep_mgf1_str(s,SHA1_SIZE,r||rstr_sha1),l=[];for(n=0;n<i.length;n+=1)l[n]=i.charCodeAt(n)^o.charCodeAt(n);var a=oaep_mgf1_str(String.fromCharCode.apply(String,l),t.length-SHA1_SIZE,rstr_sha1),u=[];for(n=0;n<s.length;n+=1)u[n]=s.charCodeAt(n)^a.charCodeAt(n);if((u=String.fromCharCode.apply(String,u)).substr(0,SHA1_SIZE)!==rstr_sha1(""))throw"Hash mismatch";var p=(u=u.substr(SHA1_SIZE)).indexOf("\x01");if((-1!=p?u.substr(0,p).lastIndexOf("\0"):-1)+1!=p)throw"Malformed data";return u.substr(p+1)}function RSASetPrivate(t,e,r){this.isPrivate=!0,"string"!=typeof t?(this.n=t,this.e=e,this.d=r):null!=t&&null!=e&&t.length>0&&e.length>0?(this.n=parseBigInt(t,16),this.e=parseInt(e,16),this.d=parseBigInt(r,16)):alert("Invalid RSA private key")}function RSASetPrivateEx(t,e,r,n,i,s,o,l){if(this.isPrivate=!0,null==t)throw"RSASetPrivateEx N == null";if(null==e)throw"RSASetPrivateEx E == null";if(0==t.length)throw"RSASetPrivateEx N.length == 0";if(0==e.length)throw"RSASetPrivateEx E.length == 0";null!=t&&null!=e&&t.length>0&&e.length>0?(this.n=parseBigInt(t,16),this.e=parseInt(e,16),this.d=parseBigInt(r,16),this.p=parseBigInt(n,16),this.q=parseBigInt(i,16),this.dmp1=parseBigInt(s,16),this.dmq1=parseBigInt(o,16),this.coeff=parseBigInt(l,16)):alert("Invalid RSA private key in RSASetPrivateEx")}function RSAGenerate(t,e){var r=new SecureRandom,n=t>>1;this.e=parseInt(e,16);for(var i=new BigInteger(e,16);;){for(;this.p=new BigInteger(t-n,1,r),0!=this.p.subtract(BigInteger.ONE).gcd(i).compareTo(BigInteger.ONE)||!this.p.isProbablePrime(10););for(;this.q=new BigInteger(n,1,r),0!=this.q.subtract(BigInteger.ONE).gcd(i).compareTo(BigInteger.ONE)||!this.q.isProbablePrime(10););if(this.p.compareTo(this.q)<=0){var s=this.p;this.p=this.q,this.q=s}var o=this.p.subtract(BigInteger.ONE),l=this.q.subtract(BigInteger.ONE),a=o.multiply(l);if(0==a.gcd(i).compareTo(BigInteger.ONE)){this.n=this.p.multiply(this.q),this.d=i.modInverse(a),this.dmp1=this.d.mod(o),this.dmq1=this.d.mod(l),this.coeff=this.q.modInverse(this.p);break}}}function RSADoPrivate(t){if(null==this.p||null==this.q)return t.modPow(this.d,this.n);for(var e=t.mod(this.p).modPow(this.dmp1,this.p),r=t.mod(this.q).modPow(this.dmq1,this.q);e.compareTo(r)<0;)e=e.add(this.p);return e.subtract(r).multiply(this.coeff).mod(this.p).multiply(this.q).add(r)}function RSADecrypt(t){var e=parseBigInt(t,16),r=this.doPrivate(e);return null==r?null:pkcs1unpad2(r,this.n.bitLength()+7>>3)}function RSADecryptOAEP(t,e){var r=parseBigInt(t,16),n=this.doPrivate(r);return null==n?null:oaep_unpad(n,this.n.bitLength()+7>>3,e)}function hex2b64(t){var e,r,n="";for(e=0;e+3<=t.length;e+=3)r=parseInt(t.substring(e,e+3),16),n+=b64map.charAt(r>>6)+b64map.charAt(63&r);if(e+1==t.length?(r=parseInt(t.substring(e,e+1),16),n+=b64map.charAt(r<<2)):e+2==t.length&&(r=parseInt(t.substring(e,e+2),16),n+=b64map.charAt(r>>2)+b64map.charAt((3&r)<<4)),b64pad)for(;(3&n.length)>0;)n+=b64pad;return n}function b64tohex(t){var e,r,n,i="",s=0;for(e=0;e<t.length&&t.charAt(e)!=b64pad;++e)(n=b64map.indexOf(t.charAt(e)))<0||(0==s?(i+=int2char(n>>2),r=3&n,s=1):1==s?(i+=int2char(r<<2|n>>4),r=15&n,s=2):2==s?(i+=int2char(r),i+=int2char(n>>2),r=3&n,s=3):(i+=int2char(r<<2|n>>4),i+=int2char(15&n),s=0));return 1==s&&(i+=int2char(r<<2)),i}function b64toBA(t){var e,r=b64tohex(t),n=new Array;for(e=0;2*e<r.length;++e)n[e]=parseInt(r.substring(2*e,2*e+2),16);return n}
/*! rsapem-1.1.js (c) 2012 Kenji Urushima | kjur.github.com/jsrsasign/license
 */
function _rsapem_pemToBase64(t){var e=t;return e=(e=(e=e.replace("-----BEGIN RSA PRIVATE KEY-----","")).replace("-----END RSA PRIVATE KEY-----","")).replace(/[ \n]+/g,"")}function _rsapem_getPosArrayOfChildrenFromHex(t){var e=new Array,r=ASN1HEX.getStartPosOfV_AtObj(t,0),n=ASN1HEX.getPosOfNextSibling_AtObj(t,r),i=ASN1HEX.getPosOfNextSibling_AtObj(t,n),s=ASN1HEX.getPosOfNextSibling_AtObj(t,i),o=ASN1HEX.getPosOfNextSibling_AtObj(t,s),l=ASN1HEX.getPosOfNextSibling_AtObj(t,o),a=ASN1HEX.getPosOfNextSibling_AtObj(t,l),u=ASN1HEX.getPosOfNextSibling_AtObj(t,a),p=ASN1HEX.getPosOfNextSibling_AtObj(t,u);return e.push(r,n,i,s,o,l,a,u,p),e}function _rsapem_getHexValueArrayOfChildrenFromHex(t){var e=_rsapem_getPosArrayOfChildrenFromHex(t),r=ASN1HEX.getHexOfV_AtObj(t,e[0]),n=ASN1HEX.getHexOfV_AtObj(t,e[1]),i=ASN1HEX.getHexOfV_AtObj(t,e[2]),s=ASN1HEX.getHexOfV_AtObj(t,e[3]),o=ASN1HEX.getHexOfV_AtObj(t,e[4]),l=ASN1HEX.getHexOfV_AtObj(t,e[5]),a=ASN1HEX.getHexOfV_AtObj(t,e[6]),u=ASN1HEX.getHexOfV_AtObj(t,e[7]),p=ASN1HEX.getHexOfV_AtObj(t,e[8]),h=new Array;return h.push(r,n,i,s,o,l,a,u,p),h}function _rsapem_readPrivateKeyFromASN1HexString(t){var e=_rsapem_getHexValueArrayOfChildrenFromHex(t);this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])}function _rsapem_readPrivateKeyFromPEMString(t){var e=_rsapem_getHexValueArrayOfChildrenFromHex(b64tohex(_rsapem_pemToBase64(t)));this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])}function _rsasign_getHexPaddedDigestInfoForString(t,e,r){var n=function(t){return KJUR.crypto.Util.hashString(t,r)}(t);return KJUR.crypto.Util.getPaddedDigestInfoHex(n,r,e)}function _zeroPaddingOfSignature(t,e){for(var r="",n=e/4-t.length,i=0;i<n;i++)r+="0";return r+t}function _rsasign_signString(t,e){var r=function(t){return KJUR.crypto.Util.hashString(t,e)}(t);return this.signWithMessageHash(r,e)}function _rsasign_signWithMessageHash(t,e){var r=parseBigInt(KJUR.crypto.Util.getPaddedDigestInfoHex(t,e,this.n.bitLength()),16);return _zeroPaddingOfSignature(this.doPrivate(r).toString(16),this.n.bitLength())}function _rsasign_signStringWithSHA1(t){return _rsasign_signString.call(this,t,"sha1")}function _rsasign_signStringWithSHA256(t){return _rsasign_signString.call(this,t,"sha256")}function pss_mgf1_str(t,e,r){for(var n="",i=0;n.length<e;)n+=hextorstr(r(rstrtohex(t+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])))),i+=1;return n}function _rsasign_signStringPSS(t,e,r){var n=function(t){return KJUR.crypto.Util.hashHex(t,e)}(rstrtohex(t));return r===undefined&&(r=-1),this.signWithMessageHashPSS(n,e,r)}function _rsasign_signWithMessageHashPSS(t,e,r){var n,i=hextorstr(t),s=i.length,o=this.n.bitLength()-1,l=Math.ceil(o/8),a=function(t){return KJUR.crypto.Util.hashHex(t,e)};if(-1===r||r===undefined)r=s;else if(-2===r)r=l-s-2;else if(r<-2)throw"invalid salt length";if(l<s+r+2)throw"data too long";var u="";r>0&&(u=new Array(r),(new SecureRandom).nextBytes(u),u=String.fromCharCode.apply(String,u));var p=hextorstr(a(rstrtohex("\0\0\0\0\0\0\0\0"+i+u))),h=[];for(n=0;n<l-r-s-2;n+=1)h[n]=0;var c=String.fromCharCode.apply(String,h)+"\x01"+u,d=pss_mgf1_str(p,c.length,a),f=[];for(n=0;n<c.length;n+=1)f[n]=c.charCodeAt(n)^d.charCodeAt(n);var g=65280>>8*l-o&255;for(f[0]&=~g,n=0;n<s;n++)f.push(p.charCodeAt(n));return f.push(188),_zeroPaddingOfSignature(this.doPrivate(new BigInteger(f)).toString(16),this.n.bitLength())}function _rsasign_getDecryptSignatureBI(t,e,r){var n=new RSAKey;return n.setPublic(e,r),n.doPublic(t)}function _rsasign_getHexDigestInfoFromSig(t,e,r){return _rsasign_getDecryptSignatureBI(t,e,r).toString(16).replace(/^1f+00/,"")}function _rsasign_getAlgNameAndHashFromHexDisgestInfo(t){for(var e in KJUR.crypto.Util.DIGESTINFOHEAD){var r=KJUR.crypto.Util.DIGESTINFOHEAD[e],n=r.length;if(t.substring(0,n)==r)return[e,t.substring(n)]}return[]}function _rsasign_verifySignatureWithArgs(t,e,r,n){var i=_rsasign_getAlgNameAndHashFromHexDisgestInfo(_rsasign_getHexDigestInfoFromSig(e,r,n));if(0==i.length)return!1;var s=i[0];return i[1]==function(t){return KJUR.crypto.Util.hashString(t,s)}(t)}function _rsasign_verifyHexSignatureForMessage(t,e){return _rsasign_verifySignatureWithArgs(e,parseBigInt(t,16),this.n.toString(16),this.e.toString(16))}function _rsasign_verifyString(t,e){var r=parseBigInt(e=(e=e.replace(_RE_HEXDECONLY,"")).replace(/[ \n]+/g,""),16);if(r.bitLength()>this.n.bitLength())return 0;var n=_rsasign_getAlgNameAndHashFromHexDisgestInfo(this.doPublic(r).toString(16).replace(/^1f+00/,""));if(0==n.length)return!1;var i=n[0];return n[1]==function(t){return KJUR.crypto.Util.hashString(t,i)}(t)}function _rsasign_verifyWithMessageHash(t,e){var r=parseBigInt(e=(e=e.replace(_RE_HEXDECONLY,"")).replace(/[ \n]+/g,""),16);if(r.bitLength()>this.n.bitLength())return 0;var n=_rsasign_getAlgNameAndHashFromHexDisgestInfo(this.doPublic(r).toString(16).replace(/^1f+00/,""));if(0==n.length)return!1;n[0];return n[1]==t}function _rsasign_verifyStringPSS(t,e,r,n){var i=function(t){return KJUR.crypto.Util.hashHex(t,r)}(rstrtohex(t));return n===undefined&&(n=-1),this.verifyWithMessageHashPSS(i,e,r,n)}function _rsasign_verifyWithMessageHashPSS(t,e,r,n){var i=new BigInteger(e,16);if(i.bitLength()>this.n.bitLength())return!1;var s,o=function(t){return KJUR.crypto.Util.hashHex(t,r)},l=hextorstr(t),a=l.length,u=this.n.bitLength()-1,p=Math.ceil(u/8);if(-1===n||n===undefined)n=a;else if(-2===n)n=p-a-2;else if(n<-2)throw"invalid salt length";if(p<a+n+2)throw"data too long";var h=this.doPublic(i).toByteArray();for(s=0;s<h.length;s+=1)h[s]&=255;for(;h.length<p;)h.unshift(0);if(188!==h[p-1])throw"encoded message does not end in 0xbc";var c=(h=String.fromCharCode.apply(String,h)).substr(0,p-a-1),d=h.substr(c.length,a),f=65280>>8*p-u&255;if(0!=(c.charCodeAt(0)&f))throw"bits beyond keysize not zero";var g=pss_mgf1_str(d,c.length,o),m=[];for(s=0;s<c.length;s+=1)m[s]=c.charCodeAt(s)^g.charCodeAt(s);m[0]&=~f;var v=p-a-n-2;for(s=0;s<v;s+=1)if(0!==m[s])throw"leftmost octets not zero";if(1!==m[v])throw"0x01 marker not found";return d===hextorstr(o(rstrtohex("\0\0\0\0\0\0\0\0"+l+String.fromCharCode.apply(String,m.slice(-n)))))}
/*! x509-1.1.2.js (c) 2012 Kenji Urushima | kjur.github.com/jsrsasign/license
 */
function X509(){this.subjectPublicKeyRSA=null,this.subjectPublicKeyRSA_hN=null,this.subjectPublicKeyRSA_hE=null,this.hex=null,this.getSerialNumberHex=function(){return ASN1HEX.getDecendantHexVByNthList(this.hex,0,[0,1])},this.getIssuerHex=function(){return ASN1HEX.getDecendantHexTLVByNthList(this.hex,0,[0,3])},this.getIssuerString=function(){return X509.hex2dn(ASN1HEX.getDecendantHexTLVByNthList(this.hex,0,[0,3]))},this.getSubjectHex=function(){return ASN1HEX.getDecendantHexTLVByNthList(this.hex,0,[0,5])},this.getSubjectString=function(){return X509.hex2dn(ASN1HEX.getDecendantHexTLVByNthList(this.hex,0,[0,5]))},this.getNotBefore=function(){var t=ASN1HEX.getDecendantHexVByNthList(this.hex,0,[0,4,0]);return t=t.replace(/(..)/g,"%$1"),t=decodeURIComponent(t)},this.getNotAfter=function(){var t=ASN1HEX.getDecendantHexVByNthList(this.hex,0,[0,4,1]);return t=t.replace(/(..)/g,"%$1"),t=decodeURIComponent(t)},this.readCertPEM=function(t){var e=X509.pemToHex(t),r=X509.getPublicKeyHexArrayFromCertHex(e),n=new RSAKey;n.setPublic(r[0],r[1]),this.subjectPublicKeyRSA=n,this.subjectPublicKeyRSA_hN=r[0],this.subjectPublicKeyRSA_hE=r[1],this.hex=e},this.readCertPEMWithoutRSAInit=function(t){var e=X509.pemToHex(t),r=X509.getPublicKeyHexArrayFromCertHex(e);this.subjectPublicKeyRSA.setPublic(r[0],r[1]),this.subjectPublicKeyRSA_hN=r[0],this.subjectPublicKeyRSA_hE=r[1],this.hex=e}}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
var dbits;(function(){function t(e,r,n){if(e===r)return 0!==e||1/e==1/r;if(null==e||null==r)return e===r;if(e._chain&&(e=e._wrapped),r._chain&&(r=r._wrapped),e.isEqual&&w.isFunction(e.isEqual))return e.isEqual(r);if(r.isEqual&&w.isFunction(r.isEqual))return r.isEqual(e);var i=u.call(e);if(i!=u.call(r))return!1;switch(i){case"[object String]":return e==String(r);case"[object Number]":return e!=+e?r!=+r:0==e?1/e==1/r:e==+r;case"[object Date]":case"[object Boolean]":return+e==+r;case"[object RegExp]":return e.source==r.source&&e.global==r.global&&e.multiline==r.multiline&&e.ignoreCase==r.ignoreCase}if("object"!=typeof e||"object"!=typeof r)return!1;for(var s=n.length;s--;)if(n[s]==e)return!0;n.push(e);var o=0,l=!0;if("[object Array]"==i){if(l=(o=e.length)==r.length)for(;o--&&(l=o in e==o in r&&t(e[o],r[o],n)););}else{if("constructor"in e!="constructor"in r||e.constructor!=r.constructor)return!1;for(var a in e)if(w.has(e,a)&&(o++,!(l=w.has(r,a)&&t(e[a],r[a],n))))break;if(l){for(a in r)if(w.has(r,a)&&!o--)break;l=!o}}return n.pop(),l}var e=this,r=e._,n={},i=Array.prototype,s=Object.prototype,o=Function.prototype,l=i.slice,a=i.unshift,u=s.toString,p=s.hasOwnProperty,h=i.forEach,c=i.map,d=i.reduce,f=i.reduceRight,g=i.filter,m=i.every,v=i.some,y=i.indexOf,b=i.lastIndexOf,_=Array.isArray,S=Object.keys,A=o.bind,w=function(t){return new M(t)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=w),exports._=w):e._=w,w.VERSION="1.3.1";var x=w.each=w.forEach=function(t,e,r){if(null!=t)if(h&&t.forEach===h)t.forEach(e,r);else if(t.length===+t.length){for(var i=0,s=t.length;i<s;i++)if(i in t&&e.call(r,t[i],i,t)===n)return}else for(var o in t)if(w.has(t,o)&&e.call(r,t[o],o,t)===n)return};w.now=Date.now||function(){return(new Date).getTime()},w.map=w.collect=function(t,e,r){var n=[];return null==t?n:c&&t.map===c?t.map(e,r):(x(t,function(t,i,s){n[n.length]=e.call(r,t,i,s)}),t.length===+t.length&&(n.length=t.length),n)},w.reduce=w.foldl=w.inject=function(t,e,r,n){var i=arguments.length>2;if(null==t&&(t=[]),d&&t.reduce===d)return n&&(e=w.bind(e,n)),i?t.reduce(e,r):t.reduce(e);if(x(t,function(t,s,o){i?r=e.call(n,r,t,s,o):(r=t,i=!0)}),!i)throw new TypeError("Reduce of empty array with no initial value");return r},w.reduceRight=w.foldr=function(t,e,r,n){var i=arguments.length>2;if(null==t&&(t=[]),f&&t.reduceRight===f)return n&&(e=w.bind(e,n)),i?t.reduceRight(e,r):t.reduceRight(e);var s=w.toArray(t).reverse();return n&&!i&&(e=w.bind(e,n)),i?w.reduce(s,e,r,n):w.reduce(s,e)},w.find=w.detect=function(t,e,r){var n;return R(t,function(t,i,s){if(e.call(r,t,i,s))return n=t,!0}),n},w.filter=w.select=function(t,e,r){var n=[];return null==t?n:g&&t.filter===g?t.filter(e,r):(x(t,function(t,i,s){e.call(r,t,i,s)&&(n[n.length]=t)}),n)},w.reject=function(t,e,r){var n=[];return null==t?n:(x(t,function(t,i,s){e.call(r,t,i,s)||(n[n.length]=t)}),n)},w.every=w.all=function(t,e,r){var i=!0;return null==t?i:m&&t.every===m?t.every(e,r):(x(t,function(t,s,o){if(!(i=i&&e.call(r,t,s,o)))return n}),i)};var R=w.some=w.any=function(t,e,r){e||(e=w.identity);var i=!1;return null==t?i:v&&t.some===v?t.some(e,r):(x(t,function(t,s,o){if(i||(i=e.call(r,t,s,o)))return n}),!!i)};w.include=w.contains=function(t,e){var r=!1;return null==t?r:y&&t.indexOf===y?-1!=t.indexOf(e):r=R(t,function(t){return t===e})},w.invoke=function(t,e){var r=l.call(arguments,2);return w.map(t,function(t){return(w.isFunction(e)?e||t:t[e]).apply(t,r)})},w.pluck=function(t,e){return w.map(t,function(t){return t[e]})},w.max=function(t,e,r){if(!e&&w.isArray(t))return Math.max.apply(Math,t);if(!e&&w.isEmpty(t))return-Infinity;var n={computed:-Infinity};return x(t,function(t,i,s){var o=e?e.call(r,t,i,s):t;o>=n.computed&&(n={value:t,computed:o})}),n.value},w.min=function(t,e,r){if(!e&&w.isArray(t))return Math.min.apply(Math,t);if(!e&&w.isEmpty(t))return Infinity;var n={computed:Infinity};return x(t,function(t,i,s){var o=e?e.call(r,t,i,s):t;o<n.computed&&(n={value:t,computed:o})}),n.value},w.shuffle=function(t){var e,r=[];return x(t,function(t,n){0==n?r[0]=t:(e=Math.floor(Math.random()*(n+1)),r[n]=r[e],r[e]=t)}),r},w.sortBy=function(t,e,r){return w.pluck(w.map(t,function(t,n,i){return{value:t,criteria:e.call(r,t,n,i)}}).sort(function(t,e){var r=t.criteria,n=e.criteria;return r<n?-1:r>n?1:0}),"value")},w.groupBy=function(t,e){var r={},n=w.isFunction(e)?e:function(t){return t[e]};return x(t,function(t,e){var i=n(t,e);(r[i]||(r[i]=[])).push(t)}),r},w.sortedIndex=function(t,e,r){r||(r=w.identity);for(var n=0,i=t.length;n<i;){var s=n+i>>1;r(t[s])<r(e)?n=s+1:i=s}return n},w.toArray=function(t){return t?t.toArray?t.toArray():w.isArray(t)?l.call(t):w.isArguments(t)?l.call(t):w.values(t):[]},w.size=function(t){return w.toArray(t).length},w.first=w.head=function(t,e,r){return null==e||r?t[0]:l.call(t,0,e)},w.initial=function(t,e,r){return l.call(t,0,t.length-(null==e||r?1:e))},w.last=function(t,e,r){return null==e||r?t[t.length-1]:l.call(t,Math.max(t.length-e,0))},w.rest=w.tail=function(t,e,r){return l.call(t,null==e||r?1:e)},w.compact=function(t){return w.filter(t,function(t){return!!t})},w.flatten=function(t,e){return w.reduce(t,function(t,r){return w.isArray(r)?t.concat(e?r:w.flatten(r)):(t[t.length]=r,t)},[])},w.without=function(t){return w.difference(t,l.call(arguments,1))},w.uniq=w.unique=function(t,e,r){var n=r?w.map(t,r):t,i=[];return w.reduce(n,function(r,n,s){return 0!=s&&(!0===e?w.last(r)==n:w.include(r,n))||(r[r.length]=n,i[i.length]=t[s]),r},[]),i},w.union=function(){return w.uniq(w.flatten(arguments,!0))},w.intersection=w.intersect=function(t){var e=l.call(arguments,1);return w.filter(w.uniq(t),function(t){return w.every(e,function(e){return w.indexOf(e,t)>=0})})},w.difference=function(t){var e=w.flatten(l.call(arguments,1));return w.filter(t,function(t){return!w.include(e,t)})},w.zip=function(){for(var t=l.call(arguments),e=w.max(w.pluck(t,"length")),r=new Array(e),n=0;n<e;n++)r[n]=w.pluck(t,""+n);return r},w.indexOf=function(t,e,r){if(null==t)return-1;var n,i;if(r)return t[n=w.sortedIndex(t,e)]===e?n:-1;if(y&&t.indexOf===y)return t.indexOf(e);for(n=0,i=t.length;n<i;n++)if(n in t&&t[n]===e)return n;return-1},w.lastIndexOf=function(t,e){if(null==t)return-1;if(b&&t.lastIndexOf===b)return t.lastIndexOf(e);for(var r=t.length;r--;)if(r in t&&t[r]===e)return r;return-1},w.range=function(t,e,r){arguments.length<=1&&(e=t||0,t=0),r=arguments[2]||1;for(var n=Math.max(Math.ceil((e-t)/r),0),i=0,s=new Array(n);i<n;)s[i++]=t,t+=r;return s};var E=function(){};w.bind=function(t,e){if(t){var r,n;if(t.bind===A&&A)return A.apply(t,l.call(arguments,1));if(!w.isFunction(t))throw new TypeError;return n=l.call(arguments,2),r=function(){if(!(this instanceof r))return t.apply(e,n.concat(l.call(arguments)));E.prototype=t.prototype;var i=new E,s=t.apply(i,n.concat(l.call(arguments)));return Object(s)===s?s:i}}},w.bindAll=function(t){var e=l.call(arguments,1);return 0==e.length&&(e=w.functions(t)),x(e,function(e){t[e]=w.bind(t[e],t)}),t},w.memoize=function(t,e){var r={};return e||(e=w.identity),function(){var n=e.apply(this,arguments);return w.has(r,n)?r[n]:r[n]=t.apply(this,arguments)}},w.delay=function(t,e){var r=l.call(arguments,2);return setTimeout(function(){return t.apply(t,r)},e)},w.defer=function(t){return w.delay.apply(w,[t,1].concat(l.call(arguments,1)))},w.throttle=function(t,e,r){var n,i,s,o,l=0;r||(r={});var a=function(){l=!1===r.leading?0:w.now(),n=null,o=t.apply(i,s),n||(i=s=null)},u=function(){var u=w.now();l||!1!==r.leading||(l=u);var p=e-(u-l);return i=this,s=arguments,p<=0||p>e?(n&&(clearTimeout(n),n=null),l=u,o=t.apply(i,s),n||(i=s=null)):n||!1===r.trailing||(n=setTimeout(a,p)),o};return u.cancel=function(){clearTimeout(n),l=0,n=i=s=null},u},w.debounce=function(t,e){var r;return function(){var n=this,i=arguments,s=function(){r=null,t.apply(n,i)};clearTimeout(r),r=setTimeout(s,e)}},w.once=function(t){var e,r=!1;return function(){return r?e:(r=!0,e=t.apply(this,arguments))}},w.wrap=function(t,e){return function(){var r=[t].concat(l.call(arguments,0));return e.apply(this,r)}},w.compose=function(){var t=arguments;return function(){for(var e=arguments,r=t.length-1;r>=0;r--)e=[t[r].apply(this,e)];return e[0]}},w.after=function(t,e){return t<=0?e():function(){if(--t<1)return e.apply(this,arguments)}},w.keys=S||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var r in t)w.has(t,r)&&(e[e.length]=r);return e},w.values=function(t){return w.map(t,w.identity)},w.functions=w.methods=function(t){var e=[];for(var r in t)w.isFunction(t[r])&&e.push(r);return e.sort()},w.extend=function(t){return x(l.call(arguments,1),function(e){for(var r in e)t[r]=e[r]}),t},w.defaults=function(t){return x(l.call(arguments,1),function(e){for(var r in e)null==t[r]&&(t[r]=e[r])}),t},w.clone=function(t){return w.isObject(t)?w.isArray(t)?t.slice():w.extend({},t):t},w.tap=function(t,e){return e(t),t},w.isEqual=function(e,r){return t(e,r,[])},w.isEmpty=function(t){if(w.isArray(t)||w.isString(t))return 0===t.length;for(var e in t)if(w.has(t,e))return!1;return!0},w.isElement=function(t){return!(!t||1!=t.nodeType)},w.isArray=_||function(t){return"[object Array]"==u.call(t)},w.isObject=function(t){return t===Object(t)},w.isArguments=function(t){return"[object Arguments]"==u.call(t)},w.isArguments(arguments)||(w.isArguments=function(t){return!(!t||!w.has(t,"callee"))}),w.isFunction=function(t){return"[object Function]"==u.call(t)},w.isString=function(t){return"[object String]"==u.call(t)},w.isNumber=function(t){return"[object Number]"==u.call(t)},w.isFinite=function(t){return w.isNumber(t)&&isFinite(t)},w.isNaN=function(t){return t!=t},w.isBoolean=function(t){return!0===t||!1===t||"[object Boolean]"==u.call(t)},w.isDate=function(t){return"[object Date]"==u.call(t)},w.isRegExp=function(t){return"[object RegExp]"==u.call(t)},w.isNull=function(t){return null===t},w.isUndefined=function(t){return void 0===t},w.has=function(t,e){return p.call(t,e)},w.noConflict=function(){return e._=r,this},w.identity=function(t){return t},w.times=function(t,e,r){for(var n=0;n<t;n++)e.call(r,n)},w.escape=function(t){return(""+t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},w.mixin=function(t){x(w.functions(t),function(e){I(e,w[e]=t[e])})};var T=0;w.uniqueId=function(t){var e=T++;return t?t+e:e},w.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var P=/.^/,C=function(t){return t.replace(/\\\\/g,"\\").replace(/\\'/g,"'")};w.template=function(t,e){var r=w.templateSettings,n="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(r.escape||P,function(t,e){return"',_.escape("+C(e)+"),'"}).replace(r.interpolate||P,function(t,e){return"',"+C(e)+",'"}).replace(r.evaluate||P,function(t,e){return"');"+C(e).replace(/[\r\n\t]/g," ")+";__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",i=new Function("obj","_",n);return e?i(e,w):function(t){return i.call(this,t,w)}},w.chain=function(t){return w(t).chain()};var M=function(t){this._wrapped=t};w.prototype=M.prototype;var O=function(t,e){return e?w(t).chain():t},I=function(t,e){M.prototype[t]=function(){var t=l.call(arguments);return a.call(t,this._wrapped),O(e.apply(w,t),this._chain)}};w.mixin(w),x(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=i[t];M.prototype[t]=function(){var r=this._wrapped;e.apply(r,arguments);var n=r.length;return"shift"!=t&&"splice"!=t||0!==n||delete r[0],O(r,this._chain)}}),x(["concat","join","slice"],function(t){var e=i[t];M.prototype[t]=function(){return O(e.apply(this._wrapped,arguments),this._chain)}}),M.prototype.chain=function(){return this._chain=!0,this},M.prototype.value=function(){return this._wrapped}}).call(this),d20.utils={SVG:{},stattracker:{},_hex_color_regex:/^#[0-9a-f]{6}$/i,_video_url_regex:/[\w\-]+\.webm/i,isVideo:t=>d20.utils._video_url_regex.test(t),_status_regex:/^(?:(dead)|([^@]+)(?:@(\d))?)$/,parseStatus:t=>{const e=d20.utils._status_regex.exec(t),r={dead:e&&e[1]||null,icon:null,color:null,number:e&&e[3]||null};if(e&&e[2]&&"dead"!==e[2])if(_.keys(d20.token_editor.colorMarkers).includes(e[2]))r.color=d20.token_editor.colorMarkers[e[2]];else{const t=_.find(token_marker_array,t=>t.tag===e[2]);if(!t)return!1;r.icon=t.id}return e&&r},getCorrectStatusName:t=>{try{const r=d20.utils._status_regex.exec(t);if(_.keys(d20.token_editor.colorMarkers).includes(r[2]))return t;const n=r[2]?parseInt(_.last(r[2].split("::"))):r[0],i=_.find(token_marker_array,t=>t.id===n);if(i){let t=i.tag;return r[3]&&(t+=`@${r[3]}`),t}return t}catch(e){return console.error(e),t}},Observable:class{constructor(){this._observers=new Map}on(t,e){const r=Symbol();let n=this._observers.get(t);return n||(n=new Map,this._observers.set(t,n)),n.set(r,e),r}off(t,e){const r=this._observers.get(t);return!!r&&r["delete"](e)}clearEventObservers(t=null){if(null===t)this._observers=new Map;else for(const e of t)this._observers["delete"](e)}trigger(t,...e){let r;try{r=this._observers.get(t).values()}catch(n){return}for(const t of r)t(...e)}}},window.d20ext=window.d20ext||{},window.d20ext.utils=d20.utils,String.prototype.tranSub=function(){var t=arguments;return this.replace(/{{[0-9]+}}/g,function(e){return t[parseInt(e.substring(2,e.length-2))]})},d20.math={add:function(t){const e=_.clone(t);for(let t=1;t<arguments.length;++t)if(arguments[t].length)for(let r=0;r<e.length;++r)e[r]+=arguments[t][r];else for(let r=0;r<e.length;++r)e[r]+=arguments[t];return e},sub:function(t){const e=_.clone(t);for(let t=1;t<arguments.length;++t)if(arguments[t].length)for(let r=0;r<e.length;++r)e[r]-=arguments[t][r];else for(let r=0;r<e.length;++r)e[r]-=arguments[t];return e},mul:function(t){const e=_.clone(t);for(let t=1;t<arguments.length;++t)for(let r=0;r<e.length;++r)e[r]*=arguments[t];return e},div:function(t){const e=_.clone(t);for(let t=1;t<arguments.length;++t)for(let r=0;r<e.length;++r)e[r]/=arguments[t];return e},dot:function(t,e){if(!t.length||t.length!==e.length)return NaN;let r=0;for(let n=0;n<t.length;++n)r+=t[n]*e[n];return r},cross:function(t,e){const r=new Array(3);return r[0]=t[1]*e[2]-t[2]*e[1],r[1]=t[2]*e[0]-t[0]*e[2],r[2]=t[0]*e[1]-t[1]*e[0],r},line_line_intersection:(t,e)=>{let r=(t,e,r,n)=>t*n-e*r,n={x:t[0][0],y:t[0][1]},i={x:t[1][0],y:t[1][1]},s={x:e[0][0],y:e[0][1]},o={x:e[1][0],y:e[1][1]},l=r(n.x-i.x,n.y-i.y,s.x-o.x,s.y-o.y);if(0===l)return NaN;{let t=r(n.x,n.y,i.x,i.y),e=r(s.x,s.y,o.x,o.y);return[r(t,n.x-i.x,e,s.x-o.x)/l,r(t,n.y-i.y,e,s.y-o.y)/l]}},lerp:(t,e,r)=>t.length!==e.length?NaN:t.length?d20.math.add(t,d20.math.mul(d20.math.sub(e,t),r)):t+r*(e-t),slerp:(t,e,r)=>{if(!t.length>1||t.length!==e.length)return NaN;const n=d20.math.clamp(d20.math.dot(d20.math.normalize(t),d20.math.normalize(e)),-1,1),i=Math.acos(n),s=Math.sin(i);return d20.math.add(d20.math.mul(t,Math.sin((1-r)*i)/s),d20.math.mul(e,Math.sin(r*i)/s))},clamp:(t,e,r)=>Math.max(e,Math.min(t,r)),degrees:t=>t/Math.PI*180,radians:t=>t/180*Math.PI,normalize:t=>{const e=d20.math.magnitude2(t);return d20.math.div(t,0===e?Infinity:Math.sqrt(e))},magnitude:t=>Math.sqrt(d20.math.dot(t,t)),magnitude2:t=>d20.math.dot(t,t),Matrix:class{static scale(t){const e=t.length,r=d20.math.Matrix.identity(e);for(let n=0;n<e;++n)r.data[n*e+n]=t[n];return r}static translate(t){const e=t.length+1,r=d20.math.Matrix.identity(e);for(let n=1;n<e;++n)r.data[n*e-1]=t[n-1];return r}static rotate2D(t,e=2){const r=Math.sin(t),n=Math.cos(t),i=this.identity(e);return i.data[0]=n,i.data[1]=-r,i.data[e]=r,i.data[e+1]=n,i}static identity(t){const e=new Array(t*t).fill(0);for(let r=0;r<t;++r)e[r*t+r]=1;return new d20.math.Matrix(e,t,t)}constructor(t,e,r){this.m=this.rows=e,this.n=this.cols=r,this.data=Object.assign([],t)}clone(){return new this.constructor(this.data,this.m,this.n)}getRows(){let t=new Array(this.rows),e=0;for(;e<this.cols;)t[e]=this.data.slice(e*this.cols,++e*this.cols);return t}getCols(){let t=new Array(this.cols);for(let e=0;e<this.cols;++e){t[e]=new Array(this.rows);for(let r=0;r<this.rows;++r)t[e][r]=this.data[r*this.cols+e]}return t}transpose(){return new d20.math.Matrix(_.flatten(this.getCols()),this.cols,this.rows)}mul(t){if(this.cols===t.rows){let e=this.getRows(),r=t.getCols(),n=new Array(this.rows*t.cols);for(let i=0;i<this.rows;++i)for(let s=0;s<t.cols;++s)n[i*t.cols+s]=d20.math.dot(e[i],r[s]);return new d20.math.Matrix(n,t.cols,this.rows)}if(this.cols===t.length){let e=this.getRows(),r=new Array(this.rows);for(let n=0;n<this.rows;++n)r[n]=d20.math.dot(e[n],t);return r}if(this.rows===t.length){let e=this.getCols(),r=new Array(this.cols);for(let n=0;n<this.cols;++n)r[n]=d20.math.dot(e[n],t);return r}return NaN}resize(t,e){let r=this.getRows();return r.splice(t,this.m-t,...new Array(Math.max(t-this.m,0)).fill(null)),r=_.chain(r).map(t=>null===t?new Array(e).fill(0):t).each(t=>t.splice(e,t.length-e,...new Array(Math.max(e-t.length,0)).fill(0))).value(),new this.constructor(r,t,e)}toFloat32Array(){return new Float32Array(this.data)}},Rectangle:class{constructor(t,e,r,n,i){this.midpoint=[t,e],this.width=r,this.height=n,this.theta=i%(2*Math.PI);const s=.5*n,o=.5*r;if(this.points=[[-o,-s],[-o,s],[o,s],[o,-s]],0!==this.theta){const t=Math.sin(i),e=Math.cos(i);this.rotation=new d20.math.Matrix([e,-t,t,e],2,2),this.rotation_inverse=this.rotation.transpose(),this.points=_.map(this.points,t=>this.rotation.mul(t))}this.points=_.map(this.points,t=>d20.math.add(t,this.midpoint))}resize(t){const e=t.left||0,r=t.right||0,n=t.up||0,i=t.down||0;let s=[[-e,0],[r,0],[0,-n],[0,i]];return this.rotation&&(s=_.map(s,t=>this.rotation.mul(t))),this.points[0]=d20.math.add(this.points[0],s[0],s[2]),this.points[1]=d20.math.add(this.points[1],s[0],s[3]),this.points[2]=d20.math.add(this.points[2],s[1],s[3]),this.points[3]=d20.math.add(this.points[3],s[1],s[2]),this.width+=e+r,this.height+=n+i,this.midpoint=d20.math.div(d20.math.sub(this.points[2],this.points[0]),2),this}translate(t){return this.midpoint=d20.math.add(this.midpoint,t),this.points=_.map(this.points,e=>d20.math.add(e,t)),this}scale(t){const e=d20.math.Matrix.scale(t);return this.points=_.map(this.points,t=>d20.math.add(e.mul(d20.math.sub(t,this.midpoint)),this.midpoint)),this}rectangleIntersection(t){const e=t=>{let e=[[1,0],[0,1]];return t.rotation?_.map(e,e=>t.rotation.mul(e)):e},r=(t,e)=>{let r=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY;for(const i of t){const t=d20.math.dot(i,e);r=Math.min(r,t),n=Math.max(n,t)}return{min:r,max:n}},n=[...e(this),...e(t)];let i=!0;for(const e of n){const n=r(this.points,e),s=r(t.points,e);if(n.max<s.min||s.max<n.min){i=!1;break}}return i}}},function(){window.customcharsheet_translation!==undefined&&(i18n.translator.add(JSON.parse(BASE64.decode(window.customcharsheet_translation))),console.log("Custom Sheet Translation")),"undefined"!=typeof JS_TRANSLATIONS&&i18n.translator.add({values:JS_TRANSLATIONS});var t={};for(var e in d20.utils.htmlTranslator=function(e,r){if(""===e)return"";void 0===r&&(r=!1);var n="jQuery";"string"==typeof e?(n="string",e=$(e)):e instanceof jQuery||(n="html",e=$(e));var i="[data-i18n],[data-i18n-placeholder],[data-i18n-title],[data-i18n-alt],[data-i18n-aria-label],[data-i18n-label]";r&&(i+=",[data-i18n-dynamic]");var s=function(t){var e=[];return"error"===t&&e.push("Missing list key."),""===t&&e.push("Empty list entry."),e.length>0&&e.join(" ")};switch(e.find(i).each(function(){var e=$(this),n=["-placeholder","-title","-alt","-aria-label","-label",""];r&&n.push("-dynamic"),$.each(n,function(){try{if(void 0===e.attr("data-i18n"+this))return;var n=""!==this&&this.substr(1),i=r&&"dynamic"===n,s=i?e.text():e.attr("data-i18n"+this),o=(e.attr("data-i18n-vars")||"").split("|"),l=i18n(s,n?"["+s+"]":'<span style="color: red;">['+s+"]</span>");if(t[s]=n?e.attr(n):e.html(),l=0===o.length?l:l.replace(/{{([0-9]+)}}/g,function(t,e){return o[e]?o[e]:"{{"+e+"}}"}),!n||i)return e.html(l),!1;e.attr(n,l)}catch(a){console.log("Translation Error:",a),console.log(e)}})}),e.find("[data-i18n-list]").each(function(){var t=$(this),e=t.attr("data-i18n-list"),r=i18n(e,"error");if(o=s(r))t.attr("data-i18n-error",o);else{var n=$.map(r.split(","),function(t){return $.trim(t)}),i=(t.find("[data-i18n-list-item]").length,t.clone()),o=!1;t.find("[data-i18n-list-item-num]").length>0?$.each(n,function(e,r){if(0===t.find('[data-i18n-list-item="'+n[e]+'"]').length)return t.attr("data-i18n-error","List does not contain the key: "+n[e]+"."),void(o=!0);i.find('[data-i18n-list-item-num="'+(e+1)+'"]').replaceWith(t.find('[data-i18n-list-item="'+r+'"]').clone().removeAttr("data-i18n-list-item-num"))}):i.find("[data-i18n-list-item]").each(function(e){if(0===t.find('[data-i18n-list-item="'+n[e]+'"]').length)return t.attr("data-i18n-error","List does not contain the key: "+n[e]+"."),void(o=!0);$(this).replaceWith(t.find('[data-i18n-list-item="'+n[e]+'"]').clone().removeAttr("data-i18n-list-item"))}),o||t.replaceWith(i)}}),window.i18nOutput=JSON.stringify(t),n){case"string":return e.prop("outerHTML");case"html":return e[0];default:return e}},d20.utils.handleURL=function(t){if(!($(this).hasClass("lightly")||$(this).parents(".note-editable").length>0)){var e=$(this).attr("href");if(void 0===e)return!1;if(-1!==e.indexOf("journal.roll20.net")||-1!==e.indexOf("wiki.roll20.net")){var r=e.split("/")[3],n=e.split("/")[4],i=d20.Campaign[r+"s"].get(n);if(i){var s=i.get("inplayerjournals").split(",");(window.is_gm||-1!==_.indexOf(s,"all")||window.currentPlayer&&-1!==_.indexOf(s,window.currentPlayer.id))&&i.view.showDialog()}return $("#existing"+r+"s").find("tr[data-"+r+"id="+n+"]").trigger("click"),!1}var o=/(?:(?:http(?:s?):\/\/(?:app\.)?roll20(?:staging)?\.(?:net|local:5000)\/|^\/?)compendium\/)([^\/]+)\/([^\/#?]+)/i,l=e.match(o);if(l)return d20.utils.openCompendiumPage(l[1],l[2]),t.stopPropagation(),void t.preventDefault();if(-1!==e.indexOf("javascript:"))return!1;if("`"===e.substring(0,1))return d20.textchat.doChatInput(e.substring(1)),!1;if("!"===e.substring(0,1))return d20.textchat.doChatInput(e),!1;if("~"===e.substring(0,1))return d20.textchat.doChatInput("%{"+e.substring(1,e.length)+"}"),!1;if(e!==undefined&&("external"===$(this).attr("rel")||-1===e.indexOf("javascript:")&&-1!==e.indexOf("://")))t.stopPropagation(),t.preventDefault(),$('<div class="dialog dialog-danger">'+e+"<br /><br />This link will open up a new window (or tab) to an external site. Just close the new window/tab to return to the editor.</div>").dialog({modal:!0,title:"Confirm External Link",buttons:{Continue:function(){$(this).dialog("destroy").remove(),window.open(e)},Cancel:function(){$(this).dialog("destroy").remove()}},beforeClose:function(){$(this).dialog("destroy").remove()}})}},d20.utils.openCompendiumPage=function(t,e,r){void 0===r&&(r=null);var n=e,i="";if(r){var s=r.split("#");n=s[0],i=s[1]?"#"+s[1]:""}var o=750,l=800,a=$(window).height()-100;a>l&&(a=l);var u=$(window).width()-50;u>o&&(u=o);var p=$("<div class='compendiumpopup'><iframe src=\""+d20.compendium.compendiumBase+"compendium/"+t+"/"+n+"?sharedCompendium="+campaign_id+i+"\" style='width: 100%; height: calc(100% - 5px);' frameborder='0'></iframe></div>");p.dialog({modal:!1,title:"<button class='showpopout btn pictos' style='margin-right: 15px;'>|</button>"+e.split(":")[0],beforeClose:function(){p.dialog("destroy").remove()},width:u+40,height:a,zIndex:11e3});var h=function(){var t=p,n=900,i=750;n=t.width(),i=t.height(),t.dialog("close");var s=window.open("/editor/popout","Popout"+(r||e),"menubar=0,location=0,toolbar=0,status=0,scrollbars=1,width="+n+",height="+i);window.allChildWindows.push(s),s.onload=function(){t.appendTo(s.document.getElementById("containerdiv")),t.show(),s.document.title=e},s.onbeforeunload=function(){window.allChildWindows=_.without(window.allChildWindows,othis.childWindow),s=null,t.html(""),t=null}};p.parent().on("click",".showpopout",function(){h()})},d20.utils.playerZoneHeight=function(){var t=$("#playerzone .player").height()+65;return $("#macrobar").is(":visible")&&(t+=$("#macrobar").height()),t},d20.utils.strip_tags=function(t,e,r){r||e===undefined||(t=html_sanitize(t,function(t,e,r,n){var i=t.toString();if(n&&"a"===n.XML_TAG)return i;var s=["https://s3.amazonaws.com/files.d20.io","http://imgsrv.roll20.net","https://imgsrv.roll20.net",imgsrv_url,"https://app.roll20.net"];for(let t=0;t<s.length;t++)if(i.substring(0,s[t].length)===s[t])return i;return/^https?:\/\//.test(i)?imgsrv_url+"/?src="+escape(i):""},function(t){var e=t.split(" ");return _.each(e,function(t,r){"userscript-"===t.substring(0,11)||"sheet-"===t.substring(0,6)?e[r]=t:e[r]="userscript-"+t}),e.join(" ")})),e=(((e||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var n=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,i=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return t.replace(i,"").replace(n,function(t,r){return e.indexOf("<"+r.toLowerCase()+">")>-1?t:""})},d20.utils.htmlAllowed="<code><span><div><label><a><br><br /><p><b><i><del><strike><u><img><video><audio><param><blockquote><mark><cite><small><ul><ol><li><hr><dl><dt><dd><sup><sub><big><pre><code><figure><figcaption><strong><em><table><tr><td><th><tbody><thead><tfoot><caption><h1><h2><h3><h4><h5><h6>",d20.utils.handleHTMLInput=function(t){return escape(d20.utils.strip_tags(d20.utils.autoLink(t),d20.utils.htmlAllowed))},d20.utils.handleHTMLOutput=function(t){return d20.utils.strip_tags(unescape(t),d20.utils.htmlAllowed)},d20.utils.showOverQuota=function(){var t=$("<div><p>We're sorry, but it looks like you've uploaded more than your allotted quota of storage space on Roll20. You can increase your quota by <a href='/account/supporter/?quotainapp' target='_blank'>becoming a Plus user</a> (or upgrading your Plus account if you already have one), or by <a href='http://help.roll20.net/sidebar-art-library/' target='_blank'>deleting items from your Art Library</a>.</div>");t.dialog({modal:!0,title:"Quota Exceeded",buttons:{"Upgrade Account":function(){window.open("/account/supporter/?quotainapp"),t.dialog("destroy")},"No Thanks":function(){t.dialog("destroy")}},beforeClose:function(){t.dialog("destroy")}})},d20.utils.showBadConvert=function(){var t=$("<div><p>There was an error trying to convert the PDF. Be sure you didn't specify an invalid page number. It's also possible the PDF is corrupted or isn't supported by our conversion software.</div>");t.dialog({modal:!0,title:"PDF Conversion Error",buttons:{"Drat!":function(){t.dialog("destroy")}},beforeClose:function(){t.dialog("destroy")}})},d20.utils.setupAvatar=function(t,e){t.bind("uploadcomplete",function(t,r){if(t.stopPropagation(),"overquota"==r)return d20.utils.showOverQuota(),!1;e.updateModel(),e.model.save({avatar:r.base.replace("/original.","/med.")+(-1===r.base.indexOf("?")?"?"+Math.floor((new Date).getTime()/1e3):"")})}),t.dndUploader({url:"/image_library/newupload",method:"POST",allowMultiple:!1}),t.bind("removeimage",function(){e.updateModel(),e.model.save({avatar:""})}),t.on("click",".remove",function(){t.trigger("removeimage")}),t.droppable({drop:function(e,r){e.originalEvent.dropHandled=!0,t.trigger("uploadcomplete",[{base:r.draggable.attr("data-fullsizeurl")},!0]),e.preventDefault(),e.stopPropagation()},hoverClass:"drop-highlight",tolerance:"touch",greedy:!0,accept:".resultimage, .library-item"})},d20.utils.summernoteInit=function(){let t=$(this),e=$('<div class="loader"></div>'),r=t.hasClass("code-view"),n=t.hasClass("in-app-editor"),i={},s=[["style",["style"]],["font",["bold","italic","underline","strikethrough","clear"]],["size",["superscript","subscript"]],["para",["ol","ul","paragraph"]]];n?(s.push(["insert",["link","unlink"]]),s.push(["hr",["hr"]]),s.push(["color",["color"]]),s.push(["tableAdd",["table","tableHeaders","addRowUp","addRowDown","addColLeft","addColRight"]]),s.push(["tableDelete",["deleteRow","deleteCol","deleteTable"]])):(s.push(["insert",["table","link","picture","hr"]]),i={onImageUpload:function(t){let r=$(this);e.show();for(let n=0;n<t.length;n++){let i=t[n].name.split(".")[0],s=new FormData;s.append("file",t[n]),$.ajax({data:s,dataType:"JSON",type:"POST",url:"/forum/upload",cache:!1,contentType:!1,processData:!1,success:function(t){"undefined"!=typeof t.error?(alert(t.error),e.hide()):r.summernote("insertImage",t.filelink,i).done(function(){e.hide()})},error:function(){alert("There was an error uploading your image. This was probably caused by either connection issues, or the file being too large."),e.hide()}})}},onImageUploadError:function(){console.error("Image Upload Error")}}),r&&s.push(["code",["codeview"]]);let o={toolbar:s,disableDragAndDrop:n,callbacks:i,maxHeight:300,dialogsInBody:n,onCreateLink:function(t){return"`"!==t[0]&&"!"!==t[0]&&"~"!==t[0]||(t=t.replace(/:/g,"&#58;")),t}};o.popover=n?{table:[],link:[]}:{table:[["add",["tableHeaders","addRowDown","addRowUp","addColLeft","addColRight"]],["delete",["deleteRow","deleteCol","deleteTable"]]]},t.summernote(o),e.hide(),t.siblings(".note-editor").append(e)},d20.utils.makeContentEditable=function(t,e,r){let n=$(e);t.html("<textarea class='summernote"+(r?" code-view":"")+"'></textarea>"),t.find("textarea.summernote").each(d20.utils.summernoteInit),t.find("textarea.summernote").summernote("focus"),n.find(".lightly").each(function(){let t=$(this),e=$(t.html());t.after(e),t.remove()}),t.find(".note-editable").html(n.html()),t.find("textarea.summernote").trigger("summernote.change")},d20.utils.addCSSRules=function(t){var e=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(e),window.createPopup||e.appendChild(document.createTextNode(""));var r=document.styleSheets[document.styleSheets.length-1];for(selector in t)if(r.insertRule)try{r.insertRule(selector+t[selector],r.cssRules.length)}catch(n){}else try{r.addRule(selector,t[selector])}catch(n){console.log("Error addding rule!"),console.log(n)}},d20.utils.defaultDiceTokens={d4:["https://s3.amazonaws.com/files.d20.io/images/779542/DEYaBdP8w9B1CUSK26im0A/thumb.png?1363050056","https://s3.amazonaws.com/files.d20.io/images/779540/P7yKde5fyGZCB1ud70UOzA/thumb.png?1363050056","https://s3.amazonaws.com/files.d20.io/images/779539/AO4m-45bGw5yOcnZXUAn9g/thumb.png?1363050056","https://s3.amazonaws.com/files.d20.io/images/779541/oWA-hmBAHNAijceHr8k-3A/thumb.png?1363050056"],d6:["https://s3.amazonaws.com/files.d20.io/images/779533/-gS85HUaXIvmE5SjGpoH4w/thumb.png?1363049998","https://s3.amazonaws.com/files.d20.io/images/779535/vkc_PT4z-d_ON1MvfHaCiA/thumb.png?1363049999","https://s3.amazonaws.com/files.d20.io/images/779534/mHDadFirie4L12_ii-HYqQ/thumb.png?1363049998","https://s3.amazonaws.com/files.d20.io/images/779531/nXqp2BhdwVsQn7cDR3cMlg/thumb.png?1363049998","https://s3.amazonaws.com/files.d20.io/images/779532/nQD5_IXYLWN7YCjnd5zugA/thumb.png?1363049998","https://s3.amazonaws.com/files.d20.io/images/779536/ttiwwiWE2PVkhD2d7fV3GA/thumb.png?1363049999"],d8:["https://s3.amazonaws.com/files.d20.io/images/779514/GPCh5vqdSwvt_ANka3yhaw/thumb.png?1363049802","https://s3.amazonaws.com/files.d20.io/images/779517/nnuf1Pe2Fq70BIs9FGI7mQ/thumb.png?1363049802","https://s3.amazonaws.com/files.d20.io/images/779516/WnwuwT7yb5VM3-KiJY3GOg/thumb.png?1363049802","https://s3.amazonaws.com/files.d20.io/images/779515/Gx21buVd6d6onPsALrGFWQ/thumb.png?1363049802","https://s3.amazonaws.com/files.d20.io/images/779518/4LqfUGiX8sBXrX9b5gUnLw/thumb.png?1363049803","https://s3.amazonaws.com/files.d20.io/images/779519/YOR5Wav0-3-L1fm4vD-LFQ/thumb.png?1363049803","https://s3.amazonaws.com/files.d20.io/images/779522/dGFXXsEJz0EPA8dRpZvOzA/thumb.png?1363049804","https://s3.amazonaws.com/files.d20.io/images/779521/QXm6GcIhK6zTdMvJZVS8Og/thumb.png?1363049804"],d10:["https://s3.amazonaws.com/files.d20.io/images/779498/fjup5Fz4iV-TFKxV9z1Qtg/thumb.png?1363049717","https://s3.amazonaws.com/files.d20.io/images/779500/ug7m7g1rII05ZFzyTrkRmw/thumb.png?1363049717","https://s3.amazonaws.com/files.d20.io/images/779499/QNZR5kGieM1x00yQvSYYbg/thumb.png?1363049717","https://s3.amazonaws.com/files.d20.io/images/779497/tkz2552-MqV8a_woAD8S4A/thumb.png?1363049717","https://s3.amazonaws.com/files.d20.io/images/779501/xKjqIxXzibpcx3Lp7UH6qg/thumb.png?1363049718","https://s3.amazonaws.com/files.d20.io/images/779502/Bpc1QATzO293LvGS3neBsQ/thumb.png?1363049718","https://s3.amazonaws.com/files.d20.io/images/779504/Bpw24T8na0nJNFdTKZX5aw/thumb.png?1363049718","https://s3.amazonaws.com/files.d20.io/images/779503/ukQbc7uDKfl62ng2EO6h6g/thumb.png?1363049719","https://s3.amazonaws.com/files.d20.io/images/779505/23948Y6_O0Bc0RuIve3BbA/thumb.png?1363049719","https://s3.amazonaws.com/files.d20.io/images/779506/VhwbFVDm2KOte5h2p97n7w/thumb.png?1363049719"],
d12:["https://s3.amazonaws.com/files.d20.io/images/779476/FRkaR6XvyzUuZb0ZB7ysCA/thumb.png?1363049489","https://s3.amazonaws.com/files.d20.io/images/779474/UyTKDHxf-fU1zC3w6udl0w/thumb.png?1363049489","https://s3.amazonaws.com/files.d20.io/images/779475/kUK2UmBaD2No00Gp4Q_OCQ/thumb.png?1363049489","https://s3.amazonaws.com/files.d20.io/images/779477/OVnJDjAkMPLk29hjpFjUvw/thumb.png?1363049489","https://s3.amazonaws.com/files.d20.io/images/779478/2la9taZk_vqdKItYZ6JEfA/thumb.png?1363049490","https://s3.amazonaws.com/files.d20.io/images/779479/fa8f9OVIBt79oETji8C8Lg/thumb.png?1363049490","https://s3.amazonaws.com/files.d20.io/images/779480/CTuw9Yiijq24ra3G9YMuPA/thumb.png?1363049490","https://s3.amazonaws.com/files.d20.io/images/779481/d4onnc7NOAbNG5JbiL9mbg/thumb.png?1363049491","https://s3.amazonaws.com/files.d20.io/images/779482/Oy2dTkB3-NlxiMsTRj78nw/thumb.png?1363049491","https://s3.amazonaws.com/files.d20.io/images/779483/mO_KU8nlO7GDQKc2J_aNeg/thumb.png?1363049491","https://s3.amazonaws.com/files.d20.io/images/779484/3MYG5dYJhiKXsRZtSUpHZw/thumb.png?1363049491","https://s3.amazonaws.com/files.d20.io/images/779485/VxA3umVDmYrH5A_VBecUIQ/thumb.png?1363049492"],d20:["https://s3.amazonaws.com/files.d20.io/images/779445/OfLXGnbkNr2qKg1Qqk4cPg/thumb.png?1363049314","https://s3.amazonaws.com/files.d20.io/images/779447/br4TdShbuMIZ-D-lyeXsKA/thumb.png?1363049315","https://s3.amazonaws.com/files.d20.io/images/779454/2ARsJLoP4tExbCWrRaaxQg/thumb.png?1363049318","https://s3.amazonaws.com/files.d20.io/images/779444/3pryVOKRxMCBisEHpH3LWg/thumb.png?1363049314","https://s3.amazonaws.com/files.d20.io/images/779446/Yk4sSF3eWfnpeJd4DQpV2A/thumb.png?1363049314","https://s3.amazonaws.com/files.d20.io/images/779450/tdvjVviFHhM_KxjFRQomhA/thumb.png?1363049316","https://s3.amazonaws.com/files.d20.io/images/779456/twbHlPq0CFjFCpAyS59CTQ/thumb.png?1363049319","https://s3.amazonaws.com/files.d20.io/images/779449/PPHDirZfEowhjBHxQdxJiw/thumb.png?1363049315","https://s3.amazonaws.com/files.d20.io/images/779448/1SpNrrunpHwrNbsKcqpCzQ/thumb.png?1363049315","https://s3.amazonaws.com/files.d20.io/images/779458/VsueBYqaDlvp9BjlXl9wMQ/thumb.png?1363049320","https://s3.amazonaws.com/files.d20.io/images/779451/nWqhH9iMimUAJh_9jOFEog/thumb.png?1363049316","https://s3.amazonaws.com/files.d20.io/images/779452/TvksvU6AZm2wmpEQ2HkBlQ/thumb.png?1363049317","https://s3.amazonaws.com/files.d20.io/images/779459/L4pwmqIbQk0TfaCMExrYxQ/thumb.png?1363049320","https://s3.amazonaws.com/files.d20.io/images/779453/MDmeMWOQ_lARfvFoT1n3KQ/thumb.png?1363049317","https://s3.amazonaws.com/files.d20.io/images/779460/my8VEGyYcJIHZN2uXP6QXQ/thumb.png?1363049321","https://s3.amazonaws.com/files.d20.io/images/779455/nuz5AefdQSB6H4mvUXoqhw/thumb.png?1363049318","https://s3.amazonaws.com/files.d20.io/images/779457/kQBunq7iXGmHNqZQCa5MCA/thumb.png?1363049319","https://s3.amazonaws.com/files.d20.io/images/779463/6n_z7Gwd7eacm3-HC-f-mg/thumb.png?1363049322","https://s3.amazonaws.com/files.d20.io/images/779462/aVz3qCe2QM2nWhn3BoT9rg/thumb.png?1363049321","https://s3.amazonaws.com/files.d20.io/images/779461/4PuFJYddJWJjj4uL5S3mxQ/thumb.png?1363049321"]},d20.utils.defaultDiceTokens)d20.utils.defaultDiceTokens[e]=_.map(d20.utils.defaultDiceTokens[e],function(t){return escape(t+"")});d20.utils.hexToRgb=function(t){return t[4]||(t=t.replace(/./g,"$&$&").slice(1)),["0x"+t[1]+t[2]|0,"0x"+t[3]+t[4]|0,"0x"+t[5]+t[6]|0]};var r={},n=function(){var t={};d20.Campaign.characters.each(function(e){var r=e.get("inplayerjournals").split(",");(window.is_gm||-1!==_.indexOf(r,"all")||window.currentPlayer&&-1!==_.indexOf(r,window.currentPlayer.id))&&(t[e.get("name").toLowerCase()]={type:"character",id:e.id})}),d20.Campaign.handouts.each(function(e){var r=e.get("inplayerjournals").split(",");(window.is_gm||-1!==_.indexOf(r,"all")||window.currentPlayer&&-1!==_.indexOf(r,window.currentPlayer.id))&&(t[e.get("name").toLowerCase()]={type:"handout",id:e.id})}),r=t};d20.utils.refreshLinkCache=_.debounce(n,100),d20.utils.autoLink=function(t){var e=/\[[^\]]+\]/g;return t=t.replace(e,function(t){t=t.substring(1,t.length-1);var e=r[t.toLowerCase()];return e?"<a href='http://journal.roll20.net/"+e.type+"/"+e.id+"'>"+t+"</a>":"["+t+"]"})};var i=$("#textchat-notifier"),s=!1;d20.utils.textchatNotify=function(t,e){!0===s&&!0!==e||(!1===t?i.hide():i.show().text(t),!0===e&&(s=!1!==t))},d20.utils.getParentsUntil=function(t,e,r){var n=[];if(r)var i=r.charAt(0);for(;t&&t!==document&&(!e||e!==t);t=t.parentNode)r?("."===i&&t.classList.contains(r.substr(1))&&n.push(t),"#"===i&&t.id===r.substr(1)&&n.push(t),"["===i&&t.hasAttribute(r.substr(1,r.length-1))&&n.push(t),t.tagName.toLowerCase()===r&&n.push(t)):n.push(t);return n}}(),window.ucfirst=function(t){return t.charAt(0).toUpperCase()+t.slice(1)},function(t,e,r){function n(e,r){this.element=e,this.options=t.extend({},s,r),this._defaults=s,this._name=i,this.init()}var i="addClear",s={closeSymbol:"&#10006;",color:"#CCC",top:-1,right:8,returnFocus:!0,showOnLoad:!1,onClear:null,hideOnBlur:!1,tabbable:!0};n.prototype={init:function(){var e,n=t(this.element),i=this,s=this.options;n.wrap("<span style='position:relative;' class='add-clear-span'></span>");var o=s.tabbable?"":" tabindex='-1'";e=t("<a href='#clear' style='display: none;'"+o+">"+s.closeSymbol+"</a>"),n.after(e),n.next().css({color:s.color,"text-decoration":"none",display:"none","line-height":1,overflow:"hidden",position:"absolute",right:s.right,top:s.top},this),n.val().length>=1&&!0===s.showOnLoad&&e.css({display:"block"}),n.focus(function(){t(this).val().length>=1&&e.css({display:"block"})}),n.blur(function(t){s.hideOnBlur&&setTimeout(function(){(t.relatedTarget||t.explicitOriginalTarget||r.activeElement)!==e[0]&&e.css({display:"none"})},0)});var l=function(){t(this).val().length>=1?e.css({display:"block"}):e.css({display:"none"})},a=function(){n.off("keyup",l),n.off("cut",l),a=l,l.call(this)};n.on("keyup",l),n.on("cut",function(){var t=this;setTimeout(function(){l.call(t)},0)}),n.on("input",function(){a.call(this)}),s.hideOnBlur&&e.blur(function(){e.css({display:"none"})}),e.click(function(e){var r=t(i.element);r.val("").trigger("keyup"),t(this).css({display:"none"}),!0===s.returnFocus&&r.focus(),s.onClear&&s.onClear(r),e.preventDefault()})}},t.fn[i]=function(e){return this.each(function(){t.data(this,"plugin_"+i)||t.data(this,"plugin_"+i,new n(this,e))})}}(jQuery,window,document),
// Copyright 2010 David Bau, all rights reserved.
//   1. Redistributions of source code must retain the above copyright
//   2. Redistributions in binary form must reproduce the above copyright
// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
// A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
function(t,e,r,n,i,s,o){function l(t){var e,n,i=this,s=t.length,o=0,l=i.i=i.j=i.m=0;for(i.S=[],i.c=[],s||(t=[s++]);o<r;)i.S[o]=o++;for(o=0;o<r;o++)l=p(l+(e=i.S[o])+t[o%s]),n=i.S[l],i.S[o]=n,i.S[l]=e;i.g=function(t){var e=i.S,n=p(i.i+1),s=e[n],o=p(i.j+s),l=e[o];e[n]=l,e[o]=s;for(var a=e[p(s+l)];--t;)l=e[o=p(o+(s=e[n=p(n+1)]))],e[n]=l,e[o]=s,a=a*r+e[p(s+l)];return i.i=n,i.j=o,a},i.g(r)}function a(t,e,r,n,i){if(r=[],i=typeof t,e&&"object"==i)for(n in t)if(n.indexOf("S")<5)try{r.push(a(t[n],e-1))}catch(s){}return r.length?r:t+("string"!=i?"\0":"")}function u(t,e,r,n){for(t+="",r=0,n=0;n<t.length;n++)e[p(n)]=p((r^=19*e[p(n)])+t.charCodeAt(n));for(n in t="",e)t+=String.fromCharCode(e[n]);return t}function p(t){return t&r-1}e.seedrandom=function(p,h){var c,d=[];p=u(a(h?[p,t]:arguments.length?p:[(new Date).getTime(),t,window],3),d),u((c=new l(d)).S,t),e.random=function(){for(var t=c.g(n),e=o,l=0;t<i;)t=(t+l)*r,e*=r,l=c.g(1);for(;t>=s;)t/=2,e/=2,l>>>=1;return(t+l)/e};var f=function(t){if(t<0)throw"n must be non-negative";var e=Math.max(Math.ceil(Math.log(t)/Math.log(r)),1);if(e>n)throw"n cannot be greater than "+r+"^"+n;var i,s=Math.pow(r,e),o=t*Math.floor(s/t),l=0;do{i=c.g(e),l++}while(i>=o&&l<100);return i%t};return Math.randomInt=f,f},o=e.pow(r,n),i=e.pow(2,i),s=2*i,u(e.random(),t)}([],Math,256,6,52);var canary=0xdeadbeefcafe,j_lm=15715070==(16777215&canary);j_lm&&"Microsoft Internet Explorer"==navigator.appName?(BigInteger.prototype.am=am2,dbits=30):j_lm&&"Netscape"!=navigator.appName?(BigInteger.prototype.am=am1,dbits=26):(BigInteger.prototype.am=am3,dbits=28),BigInteger.prototype.DB=dbits,BigInteger.prototype.DM=(1<<dbits)-1,BigInteger.prototype.DV=1<<dbits;var BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP),BigInteger.prototype.F1=BI_FP-dbits,BigInteger.prototype.F2=2*dbits-BI_FP;var BI_RM="0123456789abcdefghijklmnopqrstuvwxyz",BI_RC=new Array,rr,vv;for(rr="0".charCodeAt(0),vv=0;vv<=9;++vv)BI_RC[rr++]=vv;for(rr="a".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr++]=vv;for(rr="A".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr++]=vv;Classic.prototype.convert=cConvert,Classic.prototype.revert=cRevert,Classic.prototype.reduce=cReduce,Classic.prototype.mulTo=cMulTo,Classic.prototype.sqrTo=cSqrTo,Montgomery.prototype.convert=montConvert,Montgomery.prototype.revert=montRevert,Montgomery.prototype.reduce=montReduce,Montgomery.prototype.mulTo=montMulTo,Montgomery.prototype.sqrTo=montSqrTo,BigInteger.prototype.copyTo=bnpCopyTo,BigInteger.prototype.fromInt=bnpFromInt,BigInteger.prototype.fromString=bnpFromString,BigInteger.prototype.clamp=bnpClamp,BigInteger.prototype.dlShiftTo=bnpDLShiftTo,BigInteger.prototype.drShiftTo=bnpDRShiftTo,BigInteger.prototype.lShiftTo=bnpLShiftTo,BigInteger.prototype.rShiftTo=bnpRShiftTo,BigInteger.prototype.subTo=bnpSubTo,BigInteger.prototype.multiplyTo=bnpMultiplyTo,BigInteger.prototype.squareTo=bnpSquareTo,BigInteger.prototype.divRemTo=bnpDivRemTo,BigInteger.prototype.invDigit=bnpInvDigit,BigInteger.prototype.isEven=bnpIsEven,BigInteger.prototype.exp=bnpExp,BigInteger.prototype.toString=bnToString,BigInteger.prototype.negate=bnNegate,BigInteger.prototype.abs=bnAbs,BigInteger.prototype.compareTo=bnCompareTo,BigInteger.prototype.bitLength=bnBitLength,BigInteger.prototype.mod=bnMod,BigInteger.prototype.modPowInt=bnModPowInt,BigInteger.ZERO=nbv(0),BigInteger.ONE=nbv(1),NullExp.prototype.convert=nNop,NullExp.prototype.revert=nNop,NullExp.prototype.mulTo=nMulTo,NullExp.prototype.sqrTo=nSqrTo,Barrett.prototype.convert=barrettConvert,Barrett.prototype.revert=barrettRevert,Barrett.prototype.reduce=barrettReduce,Barrett.prototype.mulTo=barrettMulTo,Barrett.prototype.sqrTo=barrettSqrTo;var lowprimes=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],lplim=(1<<26)/lowprimes[lowprimes.length-1];BigInteger.prototype.chunkSize=bnpChunkSize,BigInteger.prototype.toRadix=bnpToRadix,BigInteger.prototype.fromRadix=bnpFromRadix,BigInteger.prototype.fromNumber=bnpFromNumber,BigInteger.prototype.bitwiseTo=bnpBitwiseTo,BigInteger.prototype.changeBit=bnpChangeBit,BigInteger.prototype.addTo=bnpAddTo,BigInteger.prototype.dMultiply=bnpDMultiply,BigInteger.prototype.dAddOffset=bnpDAddOffset,BigInteger.prototype.multiplyLowerTo=bnpMultiplyLowerTo,BigInteger.prototype.multiplyUpperTo=bnpMultiplyUpperTo,BigInteger.prototype.modInt=bnpModInt,BigInteger.prototype.millerRabin=bnpMillerRabin,BigInteger.prototype.clone=bnClone,BigInteger.prototype.intValue=bnIntValue,BigInteger.prototype.byteValue=bnByteValue,BigInteger.prototype.shortValue=bnShortValue,BigInteger.prototype.signum=bnSigNum,BigInteger.prototype.toByteArray=bnToByteArray,BigInteger.prototype.equals=bnEquals,BigInteger.prototype.min=bnMin,BigInteger.prototype.max=bnMax,BigInteger.prototype.and=bnAnd,BigInteger.prototype.or=bnOr,BigInteger.prototype.xor=bnXor,BigInteger.prototype.andNot=bnAndNot,BigInteger.prototype.not=bnNot,BigInteger.prototype.shiftLeft=bnShiftLeft,BigInteger.prototype.shiftRight=bnShiftRight,BigInteger.prototype.getLowestSetBit=bnGetLowestSetBit,BigInteger.prototype.bitCount=bnBitCount,BigInteger.prototype.testBit=bnTestBit,BigInteger.prototype.setBit=bnSetBit,BigInteger.prototype.clearBit=bnClearBit,BigInteger.prototype.flipBit=bnFlipBit,BigInteger.prototype.add=bnAdd,BigInteger.prototype.subtract=bnSubtract,BigInteger.prototype.multiply=bnMultiply,BigInteger.prototype.divide=bnDivide,BigInteger.prototype.remainder=bnRemainder,BigInteger.prototype.divideAndRemainder=bnDivideAndRemainder,BigInteger.prototype.modPow=bnModPow,BigInteger.prototype.modInverse=bnModInverse,BigInteger.prototype.pow=bnPow,BigInteger.prototype.gcd=bnGCD,BigInteger.prototype.isProbablePrime=bnIsProbablePrime,BigInteger.prototype.square=bnSquare;var SHA1_SIZE=20;RSAKey.prototype.doPublic=RSADoPublic,RSAKey.prototype.setPublic=RSASetPublic,RSAKey.prototype.encrypt=RSAEncrypt,RSAKey.prototype.encryptOAEP=RSAEncryptOAEP,RSAKey.prototype.type="RSA";var SHA1_SIZE=20;RSAKey.prototype.doPrivate=RSADoPrivate,RSAKey.prototype.setPrivate=RSASetPrivate,RSAKey.prototype.setPrivateEx=RSASetPrivateEx,RSAKey.prototype.generate=RSAGenerate,RSAKey.prototype.decrypt=RSADecrypt,RSAKey.prototype.decryptOAEP=RSADecryptOAEP;
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",b64pad="=",CryptoJS=CryptoJS||function(t,e){var r={},n=r.lib={},i=n.Base=function(){function t(){}return{extend:function(e){t.prototype=this;var r=new t;return e&&r.mixIn(e),r.hasOwnProperty("init")||(r.init=function(){r.$super.init.apply(this,arguments)}),r.init.prototype=r,r.$super=this,r},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),s=n.WordArray=i.extend({init:function(t,r){t=this.words=t||[],this.sigBytes=r!=e?r:4*t.length},toString:function(t){return(t||l).stringify(this)},concat:function(t){var e=this.words,r=t.words,n=this.sigBytes,i=t.sigBytes;if(this.clamp(),n%4)for(var s=0;s<i;s++){var o=r[s>>>2]>>>24-s%4*8&255;e[n+s>>>2]|=o<<24-(n+s)%4*8}else if(r.length>65535)for(s=0;s<i;s+=4)e[n+s>>>2]=r[s>>>2];else e.push.apply(e,r);return this.sigBytes+=i,this},clamp:function(){var e=this.words,r=this.sigBytes;e[r>>>2]&=4294967295<<32-r%4*8,e.length=t.ceil(r/4)},clone:function(){var t=i.clone.call(this);return t.words=this.words.slice(0),t},random:function(e){for(var r=[],n=0;n<e;n+=4)r.push(4294967296*t.random()|0);return new s.init(r,e)}}),o=r.enc={},l=o.Hex={stringify:function(t){for(var e=t.words,r=t.sigBytes,n=[],i=0;i<r;i++){var s=e[i>>>2]>>>24-i%4*8&255;n.push((s>>>4).toString(16)),n.push((15&s).toString(16))}return n.join("")},parse:function(t){for(var e=t.length,r=[],n=0;n<e;n+=2)r[n>>>3]|=parseInt(t.substr(n,2),16)<<24-n%8*4;return new s.init(r,e/2)}},a=o.Latin1={stringify:function(t){for(var e=t.words,r=t.sigBytes,n=[],i=0;i<r;i++){var s=e[i>>>2]>>>24-i%4*8&255;n.push(String.fromCharCode(s))}return n.join("")},parse:function(t){for(var e=t.length,r=[],n=0;n<e;n++)r[n>>>2]|=(255&t.charCodeAt(n))<<24-n%4*8;return new s.init(r,e)}},u=o.Utf8={stringify:function(t){try{return decodeURIComponent(escape(a.stringify(t)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(t){return a.parse(unescape(encodeURIComponent(t)))}},p=n.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=u.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(e){var r=this._data,n=r.words,i=r.sigBytes,o=this.blockSize,l=i/(4*o),a=(l=e?t.ceil(l):t.max((0|l)-this._minBufferSize,0))*o,u=t.min(4*a,i);if(a){for(var p=0;p<a;p+=o)this._doProcessBlock(n,p);var h=n.splice(0,a);r.sigBytes-=u}return new s.init(h,u)},clone:function(){var t=i.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0}),h=(n.Hasher=p.extend({cfg:i.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){p.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(t){return function(e,r){return new t.init(r).finalize(e)}},_createHmacHelper:function(t){return function(e,r){return new h.HMAC.init(t,r).finalize(e)}}}),r.algo={});return r}(Math);!function(){var t=CryptoJS,e=t.lib,r=e.WordArray,n=e.Hasher,i=t.algo,s=[],o=i.SHA1=n.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(t,e){for(var r=this._hash.words,n=r[0],i=r[1],o=r[2],l=r[3],a=r[4],u=0;u<80;u++){if(u<16)s[u]=0|t[e+u];else{var p=s[u-3]^s[u-8]^s[u-14]^s[u-16];s[u]=p<<1|p>>>31}var h=(n<<5|n>>>27)+a+s[u];h+=u<20?1518500249+(i&o|~i&l):u<40?1859775393+(i^o^l):u<60?(i&o|i&l|o&l)-1894007588:(i^o^l)-899497514,a=l,l=o,o=i<<30|i>>>2,i=n,n=h}r[0]=r[0]+n|0,r[1]=r[1]+i|0,r[2]=r[2]+o|0,r[3]=r[3]+l|0,r[4]=r[4]+a|0},_doFinalize:function(){var t=this._data,e=t.words,r=8*this._nDataBytes,n=8*t.sigBytes;return e[n>>>5]|=128<<24-n%32,e[14+(n+64>>>9<<4)]=Math.floor(r/4294967296),e[15+(n+64>>>9<<4)]=r,t.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=n.clone.call(this);return t._hash=this._hash.clone(),t}});t.SHA1=n._createHelper(o),t.HmacSHA1=n._createHmacHelper(o)}(),RSAKey.prototype.readPrivateKeyFromPEMString=_rsapem_readPrivateKeyFromPEMString,RSAKey.prototype.readPrivateKeyFromASN1HexString=_rsapem_readPrivateKeyFromASN1HexString;
/*! rsasign-1.2.7.js (c) 2012 Kenji Urushima | kjur.github.com/jsrsasign/license
 */
var _RE_HEXDECONLY=new RegExp("");_RE_HEXDECONLY.compile("[^0-9a-f]","gi"),RSAKey.prototype.signWithMessageHash=_rsasign_signWithMessageHash,RSAKey.prototype.signString=_rsasign_signString,RSAKey.prototype.signStringWithSHA1=_rsasign_signStringWithSHA1,RSAKey.prototype.signStringWithSHA256=_rsasign_signStringWithSHA256,RSAKey.prototype.sign=_rsasign_signString,RSAKey.prototype.signWithSHA1=_rsasign_signStringWithSHA1,RSAKey.prototype.signWithSHA256=_rsasign_signStringWithSHA256,RSAKey.prototype.signWithMessageHashPSS=_rsasign_signWithMessageHashPSS,RSAKey.prototype.signStringPSS=_rsasign_signStringPSS,RSAKey.prototype.signPSS=_rsasign_signStringPSS,RSAKey.SALT_LEN_HLEN=-1,RSAKey.SALT_LEN_MAX=-2,RSAKey.prototype.verifyWithMessageHash=_rsasign_verifyWithMessageHash,RSAKey.prototype.verifyString=_rsasign_verifyString,RSAKey.prototype.verifyHexSignatureForMessage=_rsasign_verifyHexSignatureForMessage,RSAKey.prototype.verify=_rsasign_verifyString,RSAKey.prototype.verifyHexSignatureForByteArrayMessage=_rsasign_verifyHexSignatureForMessage,RSAKey.prototype.verifyWithMessageHashPSS=_rsasign_verifyWithMessageHashPSS,RSAKey.prototype.verifyStringPSS=_rsasign_verifyStringPSS,RSAKey.prototype.verifyPSS=_rsasign_verifyStringPSS,RSAKey.SALT_LEN_RECOVER=-2;
/*! asn1hex-1.1.4.js (c) 2012-2013 Kenji Urushima | kjur.github.com/jsrsasign/license
 */
var ASN1HEX=new function(){this.getByteLengthOfL_AtObj=function(t,e){if("8"!=t.substring(e+2,e+3))return 1;var r=parseInt(t.substring(e+3,e+4));return 0==r?-1:0<r&&r<10?r+1:-2},this.getHexOfL_AtObj=function(t,e){var r=this.getByteLengthOfL_AtObj(t,e);return r<1?"":t.substring(e+2,e+2+2*r)},this.getIntOfL_AtObj=function(t,e){var r=this.getHexOfL_AtObj(t,e);return""==r?-1:(parseInt(r.substring(0,1))<8?new BigInteger(r,16):new BigInteger(r.substring(2),16)).intValue()},this.getStartPosOfV_AtObj=function(t,e){var r=this.getByteLengthOfL_AtObj(t,e);return r<0?r:e+2*(r+1)},this.getHexOfV_AtObj=function(t,e){var r=this.getStartPosOfV_AtObj(t,e),n=this.getIntOfL_AtObj(t,e);return t.substring(r,r+2*n)},this.getHexOfTLV_AtObj=function(t,e){return t.substr(e,2)+this.getHexOfL_AtObj(t,e)+this.getHexOfV_AtObj(t,e)},this.getPosOfNextSibling_AtObj=function(t,e){return this.getStartPosOfV_AtObj(t,e)+2*this.getIntOfL_AtObj(t,e)},this.getPosArrayOfChildren_AtObj=function(t,e){var r=new Array,n=this.getStartPosOfV_AtObj(t,e);r.push(n);for(var i=this.getIntOfL_AtObj(t,e),s=n,o=0;;){var l=this.getPosOfNextSibling_AtObj(t,s);if(null==l||l-n>=2*i)break;if(o>=200)break;r.push(l),s=l,o++}return r},this.getNthChildIndex_AtObj=function(t,e,r){return this.getPosArrayOfChildren_AtObj(t,e)[r]},this.getDecendantIndexByNthList=function(t,e,r){if(0==r.length)return e;var n=r.shift(),i=this.getPosArrayOfChildren_AtObj(t,e);return this.getDecendantIndexByNthList(t,i[n],r)},this.getDecendantHexTLVByNthList=function(t,e,r){var n=this.getDecendantIndexByNthList(t,e,r);return this.getHexOfTLV_AtObj(t,n)},this.getDecendantHexVByNthList=function(t,e,r){var n=this.getDecendantIndexByNthList(t,e,r);return this.getHexOfV_AtObj(t,n)}};ASN1HEX.getVbyList=function(t,e,r,n){var i=this.getDecendantIndexByNthList(t,e,r);if(i===undefined)throw"can't find nthList object";if(n!==undefined&&t.substr(i,2)!=n)throw"checking tag doesn't match: "+t.substr(i,2)+"!="+n;return this.getHexOfV_AtObj(t,i)},X509.pemToBase64=function(t){var e=t;return e=(e=(e=e.replace("-----BEGIN CERTIFICATE-----","")).replace("-----END CERTIFICATE-----","")).replace(/[ \n]+/g,"")},X509.pemToHex=function(t){return b64tohex(X509.pemToBase64(t))},X509.getSubjectPublicKeyPosFromCertHex=function(t){var e=X509.getSubjectPublicKeyInfoPosFromCertHex(t);if(-1==e)return-1;var r=ASN1HEX.getPosArrayOfChildren_AtObj(t,e);if(2!=r.length)return-1;var n=r[1];if("03"!=t.substring(n,n+2))return-1;var i=ASN1HEX.getStartPosOfV_AtObj(t,n);return"00"!=t.substring(i,i+2)?-1:i+2},X509.getSubjectPublicKeyInfoPosFromCertHex=function(t){var e=ASN1HEX.getStartPosOfV_AtObj(t,0),r=ASN1HEX.getPosArrayOfChildren_AtObj(t,e);return r.length<1?-1:"a003020102"==t.substring(r[0],r[0]+10)?r.length<6?-1:r[6]:r.length<5?-1:r[5]},X509.getPublicKeyHexArrayFromCertHex=function(t){var e=X509.getSubjectPublicKeyPosFromCertHex(t),r=ASN1HEX.getPosArrayOfChildren_AtObj(t,e);if(2!=r.length)return[];var n=ASN1HEX.getHexOfV_AtObj(t,r[0]),i=ASN1HEX.getHexOfV_AtObj(t,r[1]);return null!=n&&null!=i?[n,i]:[]},X509.getHexTbsCertificateFromCert=function(t){return ASN1HEX.getStartPosOfV_AtObj(t,0)},X509.getPublicKeyHexArrayFromCertPEM=function(t){var e=X509.pemToHex(t);return X509.getPublicKeyHexArrayFromCertHex(e)},X509.hex2dn=function(t){for(var e="",r=ASN1HEX.getPosArrayOfChildren_AtObj(t,0),n=0;n<r.length;n++){var i=ASN1HEX.getHexOfTLV_AtObj(t,r[n]);e=e+"/"+X509.hex2rdn(i)}return e},X509.hex2rdn=function(t){var e=ASN1HEX.getDecendantHexTLVByNthList(t,0,[0,0]),r=ASN1HEX.getDecendantHexVByNthList(t,0,[0,1]),n="";try{n=X509.DN_ATTRHEX[e]}catch(i){n=e}return r=r.replace(/(..)/g,"%$1"),n+"="+decodeURIComponent(r)},X509.DN_ATTRHEX={"0603550406":"C","060355040a":"O","060355040b":"OU","0603550403":"CN","0603550405":"SN","0603550408":"ST","0603550407":"L"},X509.getPublicKeyFromCertPEM=function(t){var e=X509.getPublicKeyInfoPropOfCertPEM(t);if("2a864886f70d010101"==e.algoid){var r=KEYUTIL.parsePublicRawRSAKeyHex(e.keyhex);return(i=new RSAKey).setPublic(r.n,r.e),i}if("2a8648ce3d0201"==e.algoid){var n=KJUR.crypto.OID.oidhex2name[e.algparam];return(i=new KJUR.crypto.ECDSA({curve:n,info:e.keyhex})).setPublicKeyHex(e.keyhex),i}if("2a8648ce380401"==e.algoid){var i,s=ASN1HEX.getVbyList(e.algparam,0,[0],"02"),o=ASN1HEX.getVbyList(e.algparam,0,[1],"02"),l=ASN1HEX.getVbyList(e.algparam,0,[2],"02"),a=ASN1HEX.getHexOfV_AtObj(e.keyhex,0);return a=a.substr(2),(i=new KJUR.crypto.DSA).setPublic(new BigInteger(s,16),new BigInteger(o,16),new BigInteger(l,16),new BigInteger(a,16)),i}throw"unsupported key"},X509.getPublicKeyInfoPropOfCertPEM=function(t){var e={algparam:null},r=X509.pemToHex(t),n=ASN1HEX.getPosArrayOfChildren_AtObj(r,0);if(3!=n.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=r.substr(n[0],2))throw"malformed X.509 certificate PEM (code:002)";var i=ASN1HEX.getPosArrayOfChildren_AtObj(r,n[0]);if(i.length<7)throw"malformed X.509 certificate PEM (code:003)";var s=ASN1HEX.getPosArrayOfChildren_AtObj(r,i[6]);if(2!=s.length)throw"malformed X.509 certificate PEM (code:004)";var o=ASN1HEX.getPosArrayOfChildren_AtObj(r,s[0]);if(2!=o.length)throw"malformed X.509 certificate PEM (code:005)";if(e.algoid=ASN1HEX.getHexOfV_AtObj(r,o[0]),"06"==r.substr(o[1],2)?e.algparam=ASN1HEX.getHexOfV_AtObj(r,o[1]):"30"==r.substr(o[1],2)&&(e.algparam=ASN1HEX.getHexOfTLV_AtObj(r,o[1])),"03"!=r.substr(s[1],2))throw"malformed X.509 certificate PEM (code:006)";var l=ASN1HEX.getHexOfV_AtObj(r,s[1]);return e.keyhex=l.substr(2),e},
/*! crypto-1.1.5.js (c) 2013 Kenji Urushima | kjur.github.com/jsrsasign/license
 */
"undefined"!=typeof KJUR&&KJUR||(KJUR={}),"undefined"!=typeof KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"},this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"},this.CRYPTOJSMESSAGEDIGESTNAME={md5:"CryptoJS.algo.MD5",sha1:"CryptoJS.algo.SHA1",sha224:"CryptoJS.algo.SHA224",sha256:"CryptoJS.algo.SHA256",sha384:"CryptoJS.algo.SHA384",sha512:"CryptoJS.algo.SHA512",ripemd160:"CryptoJS.algo.RIPEMD160"},this.getDigestInfoHex=function(t,e){if("undefined"==typeof this.DIGESTINFOHEAD[e])throw"alg not supported in Util.DIGESTINFOHEAD: "+e;return this.DIGESTINFOHEAD[e]+t},this.getPaddedDigestInfoHex=function(t,e,r){var n=this.getDigestInfoHex(t,e),i=r/4;if(n.length+22>i)throw"key is too short for SigAlg: keylen="+r+","+e;for(var s="0001",o="00"+n,l="",a=i-s.length-o.length,u=0;u<a;u+=2)l+="ff";return s+l+o},this.hashString=function(t,e){return new KJUR.crypto.MessageDigest({alg:e}).digestString(t)},this.hashHex=function(t,e){return new KJUR.crypto.MessageDigest({alg:e}).digestHex(t)},this.sha1=function(t){return new KJUR.crypto.MessageDigest({alg:"sha1",prov:"cryptojs"}).digestString(t)},this.sha256=function(t){return new KJUR.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"}).digestString(t)},this.sha256Hex=function(t){return new KJUR.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"}).digestHex(t)},this.sha512=function(t){return new KJUR.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"}).digestString(t)},this.sha512Hex=function(t){return new KJUR.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"}).digestHex(t)},this.md5=function(t){return new KJUR.crypto.MessageDigest({alg:"md5",prov:"cryptojs"}).digestString(t)},this.ripemd160=function(t){return new KJUR.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"}).digestString(t)},this.getCryptoJSMDByName=function(){}},KJUR.crypto.MessageDigest=function(params){var md=null,algName=null,provName=null;this.setAlgAndProvider=function(alg,prov){if(null!=alg&&prov===undefined&&(prov=KJUR.crypto.Util.DEFAULTPROVIDER[alg]),-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(alg)&&"cryptojs"==prov){try{this.md=eval(KJUR.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[alg]).create()}catch(ex){throw"setAlgAndProvider hash alg set fail alg="+alg+"/"+ex}this.updateString=function(t){this.md.update(t)},this.updateHex=function(t){var e=CryptoJS.enc.Hex.parse(t);this.md.update(e)},this.digest=function(){return this.md.finalize().toString(CryptoJS.enc.Hex)},this.digestString=function(t){return this.updateString(t),this.digest()},this.digestHex=function(t){return this.updateHex(t),this.digest()}}if(-1!=":sha256:".indexOf(alg)&&"sjcl"==prov){try{this.md=new sjcl.hash.sha256}catch(ex){throw"setAlgAndProvider hash alg set fail alg="+alg+"/"+ex}this.updateString=function(t){this.md.update(t)},this.updateHex=function(t){var e=sjcl.codec.hex.toBits(t);this.md.update(e)},this.digest=function(){var t=this.md.finalize();return sjcl.codec.hex.fromBits(t)},this.digestString=function(t){return this.updateString(t),this.digest()},this.digestHex=function(t){return this.updateHex(t),this.digest()}}},this.updateString=function(){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.updateHex=function(){throw"updateHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestString=function(){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestHex=function(){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},params!==undefined&&params.alg!==undefined&&(this.algName=params.alg,params.prov===undefined&&(this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName))},KJUR.crypto.Mac=function(params){var mac=null,pass=null,algName=null,provName=null,algProv=null;this.setAlgAndProvider=function(alg,prov){if(null==alg&&(alg="hmacsha1"),alg=alg.toLowerCase(),"hmac"!=alg.substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+alg;prov===undefined&&(prov=KJUR.crypto.Util.DEFAULTPROVIDER[alg]),this.algProv=alg+"/"+prov;var hashAlg=alg.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(hashAlg)&&"cryptojs"==prov){try{var mdObj=eval(KJUR.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[hashAlg]);this.mac=CryptoJS.algo.HMAC.create(mdObj,this.pass)}catch(ex){throw"setAlgAndProvider hash alg set fail hashAlg="+hashAlg+"/"+ex}this.updateString=function(t){this.mac.update(t)},this.updateHex=function(t){var e=CryptoJS.enc.Hex.parse(t);this.mac.update(e)},this.doFinal=function(){return this.mac.finalize().toString(CryptoJS.enc.Hex)},this.doFinalString=function(t){return this.updateString(t),this.doFinal()},this.doFinalHex=function(t){return this.updateHex(t),this.doFinal()}}},this.updateString=function(){throw"updateString(str) not supported for this alg/prov: "+this.algProv},this.updateHex=function(){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv},this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv},this.doFinalString=function(){throw"digestString(str) not supported for this alg/prov: "+this.algProv},this.doFinalHex=function(){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv},params!==undefined&&(params.pass!==undefined&&(this.pass=params.pass),params.alg!==undefined&&(this.algName=params.alg,params.prov===undefined&&(this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))},KJUR.crypto.Signature=function(t){var e=null;if(this._setAlgNames=function(){this.algName.match(/^(.+)with(.+)$/)&&(this.mdAlgName=RegExp.$1.toLowerCase(),this.pubkeyAlgName=RegExp.$2.toLowerCase())},this._zeroPaddingOfSignature=function(t,e){for(var r="",n=e/4-t.length,i=0;i<n;i++)r+="0";return r+t},this.setAlgAndProvider=function(t,e){if(this._setAlgNames(),"cryptojs/jsrsa"!=e)throw"provider not supported: "+e;if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new KJUR.crypto.MessageDigest({alg:this.mdAlgName})}catch(r){throw"setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+r}this.init=function(t,e){var r=null;try{r=e===undefined?KEYUTIL.getKey(t):KEYUTIL.getKey(t,e)}catch(n){throw"init failed:"+n}if(!0===r.isPrivate)this.prvKey=r,this.state="SIGN";else{if(!0!==r.isPublic)throw"init failed.:"+r;this.pubKey=r,this.state="VERIFY"}},this.initSign=function(t){"string"==typeof t.ecprvhex&&"string"==typeof t.eccurvename?(this.ecprvhex=t.ecprvhex,this.eccurvename=t.eccurvename):this.prvKey=t,this.state="SIGN"},this.initVerifyByPublicKey=function(t){"string"==typeof t.ecpubhex&&"string"==typeof t.eccurvename?(this.ecpubhex=t.ecpubhex,this.eccurvename=t.eccurvename):t instanceof KJUR.crypto.ECDSA?this.pubKey=t:t instanceof RSAKey&&(this.pubKey=t),this.state="VERIFY"},this.initVerifyByCertificatePEM=function(t){var e=new X509;e.readCertPEM(t),this.pubKey=e.subjectPublicKeyRSA,this.state="VERIFY"},this.updateString=function(t){this.md.updateString(t)},this.updateHex=function(t){this.md.updateHex(t)},this.sign=function(){if(this.sHashHex=this.md.digest(),"undefined"!=typeof this.ecprvhex&&"undefined"!=typeof this.eccurvename){var t=new KJUR.crypto.ECDSA({curve:this.eccurvename});this.hSign=t.signHex(this.sHashHex,this.ecprvhex)}else if("rsaandmgf1"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,this.mdAlgName,this.pssSaltLen);else if("rsa"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof KJUR.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else{if(!(this.prvKey instanceof KJUR.crypto.DSA))throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;this.hSign=this.prvKey.signWithMessageHash(this.sHashHex)}return this.hSign},this.signString=function(t){this.updateString(t),this.sign()},this.signHex=function(t){this.updateHex(t),this.sign()},this.verify=function(t){if(this.sHashHex=this.md.digest(),"undefined"!=typeof this.ecpubhex&&"undefined"!=typeof this.eccurvename)return new KJUR.crypto.ECDSA({curve:this.eccurvename}).verifyHex(this.sHashHex,t,this.ecpubhex);if("rsaandmgf1"==this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,t,this.mdAlgName,this.pssSaltLen);if("rsa"==this.pubkeyAlgName)return this.pubKey.verifyWithMessageHash(this.sHashHex,t);if(this.pubKey instanceof KJUR.crypto.ECDSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,t);if(this.pubKey instanceof KJUR.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,t);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName}}},this.init=function(){throw"init(key, pass) not supported for this alg:prov="+this.algProvName},this.initVerifyByPublicKey=function(){throw"initVerifyByPublicKey(rsaPubKeyy) not supported for this alg:prov="+this.algProvName},this.initVerifyByCertificatePEM=function(){throw"initVerifyByCertificatePEM(certPEM) not supported for this alg:prov="+this.algProvName},this.initSign=function(){throw"initSign(prvKey) not supported for this alg:prov="+this.algProvName},this.updateString=function(){throw"updateString(str) not supported for this alg:prov="+this.algProvName},this.updateHex=function(){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName},this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName},this.signString=function(){throw"digestString(str) not supported for this alg:prov="+this.algProvName},this.signHex=function(){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName},this.verify=function(){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName},this.initParams=t,t!==undefined&&(t.alg!==undefined&&(this.algName=t.alg,t.prov===undefined?this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]:this.provName=t.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),t.psssaltlen!==undefined&&(this.pssSaltLen=t.psssaltlen),t.prvkeypem!==undefined)){if(t.prvkeypas!==undefined)throw"both prvkeypem and prvkeypas parameters not supported";try{(e=new RSAKey).readPrivateKeyFromPEMString(t.prvkeypem),this.initSign(e)}catch(r){throw"fatal error to load pem private key: "+r}}},KJUR.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1","2b81040023":"secp521r1","2b81040022":"secp384r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}},d20.DicePEG=function(){function quote(t){return'"'+t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var result={parse:function(input,startRule){function padLeft(t,e,r){for(var n=t,i=r-t.length,s=0;s<i;s++)n=e+n;return n}function escape(t){var e,r,n=t.charCodeAt(0);return n<=255?(e="x",r=2):(e="u",r=4),"\\"+e+padLeft(n.toString(16).toUpperCase(),"0",r)}function matchFailed(t){pos<rightmostFailuresPos||(pos>rightmostFailuresPos&&(rightmostFailuresPos=pos,rightmostFailuresExpected=[]),rightmostFailuresExpected.push(t))}function parse_start(){var t,e,r,n,i,s,o;if(n=pos,i=pos,null!==(t=parse_rollExpression())){for(e=[],input.length>pos?(r=input.charAt(pos),pos++):(r=null,0===reportFailures&&matchFailed("any character"));null!==r;)e.push(r),input.length>pos?(r=input.charAt(pos),pos++):(r=null,0===reportFailures&&matchFailed("any character"));null!==e?t=[t,e]:(t=null,pos=i)}else t=null,pos=i;return null!==t&&(s=t[0],o=t[1],Array.isArray(s)||(s=[s]),""!==o&&(o=o.join("")).trim().length>0&&s.push(new Comment(o)),t=s),null===t&&(pos=n),t}function parse_rollExpression(){var t,e,r,n,i,s,o,l,a;return n=pos,i=pos,null!==(t=parse_rollExpressionPrimary())&&null!==(e=parse_labelAwareRollOperator())&&null!==(r=parse_rollExpression())?t=[t,e,r]:(t=null,pos=i),null!==t&&(s=t[0],o=t[1],l=t[2],t=mergeExpressions(mergeExpressions(s,o),l)),null===t&&(pos=n),null===t&&(n=pos,i=pos,null!==(t=parse_rollExpressionPrimary())&&null!==(e=parse_inlineLabelWithSpace())?t=[t,e]:(t=null,pos=i),null!==t&&(t=mergeExpressions(t[0],t[1])),null===t&&(pos=n),null===t&&(n=pos,i=pos,null!==(t=parse_inlineLabelWithSpace())&&null!==(e=parse_rollExpression())?t=[t,e]:(t=null,pos=i),null!==t&&(t=mergeExpressions(t[0],t[1])),null===t&&(pos=n),null===t&&(n=pos,null!==(t=parse_rollExpressionPrimary())&&(a=t,Array.isArray(a)||(a=[a]),t=a),null===t&&(pos=n)))),t}function parse_rollExpressionPrimary(){var t,e,r,n,i,s,o,l;return s=pos,o=pos,null!==(t=parse_fullRoll())?(l=pos,reportFailures++,e=parse_validRollSuffix(),reportFailures--,null!==e?(e="",pos=l):e=null,null!==e?t=[t,e]:(t=null,pos=o)):(t=null,pos=o),null!==t&&(t=t[0]),null===t&&(pos=s),null===t&&(s=pos,o=pos,null!==(t=parse_rollGroup())?(l=pos,reportFailures++,e=parse_validRollSuffix(),reportFailures--,null!==e?(e="",pos=l):e=null,null!==e?t=[t,e]:(t=null,pos=o)):(t=null,pos=o),null!==t&&(t=t[0]),null===t&&(pos=s),null===t&&(s=pos,null!==(t=parse_number())&&(t=new MathExpression(t)),null===t&&(pos=s),null===t&&(s=pos,o=pos,"floor("===input.substr(pos,6)?(t="floor(",pos+=6):(t=null,0===reportFailures&&matchFailed('"floor("')),null!==t&&null!==(e=parse__())&&null!==(r=parse_rollExpression())&&null!==(n=parse__())?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,r,n,i]:(t=null,pos=o)):(t=null,pos=o),null!==t&&(t=mergeExpressions("floor(",mergeExpressions(t[2],")"))),null===t&&(pos=s),null===t&&(s=pos,o=pos,"ceil("===input.substr(pos,5)?(t="ceil(",pos+=5):(t=null,0===reportFailures&&matchFailed('"ceil("')),null!==t&&null!==(e=parse__())&&null!==(r=parse_rollExpression())&&null!==(n=parse__())?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,r,n,i]:(t=null,pos=o)):(t=null,pos=o),null!==t&&(t=mergeExpressions("ceil(",mergeExpressions(t[2],")"))),null===t&&(pos=s),null===t&&(s=pos,o=pos,"round("===input.substr(pos,6)?(t="round(",pos+=6):(t=null,0===reportFailures&&matchFailed('"round("')),null!==t&&null!==(e=parse__())&&null!==(r=parse_rollExpression())&&null!==(n=parse__())?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,r,n,i]:(t=null,pos=o)):(t=null,pos=o),null!==t&&(t=mergeExpressions("round(",mergeExpressions(t[2],")"))),null===t&&(pos=s),null===t&&(s=pos,o=pos,"abs("===input.substr(pos,4)?(t="abs(",pos+=4):(t=null,0===reportFailures&&matchFailed('"abs("')),null!==t&&null!==(e=parse__())&&null!==(r=parse_rollExpression())&&null!==(n=parse__())?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,r,n,i]:(t=null,pos=o)):(t=null,pos=o),null!==t&&(t=mergeExpressions("abs(",mergeExpressions(t[2],")"))),null===t&&(pos=s),null===t&&(s=pos,o=pos,40===input.charCodeAt(pos)?(t="(",pos++):(t=null,0===reportFailures&&matchFailed('"("')),null!==t&&null!==(e=parse__())&&null!==(r=parse_rollExpression())&&null!==(n=parse__())?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,r,n,i]:(t=null,pos=o)):(t=null,pos=o),null!==t&&(t=mergeExpressions("(",mergeExpressions(t[2],")"))),null===t&&(pos=s)))))))),t}function parse_validRollSuffix(){var t,e;return null===(t=parse___())&&null===(t=parse_inlineLabelWithSpace())&&(125===input.charCodeAt(pos)?(t="}",pos++):(t=null,0===reportFailures&&matchFailed('"}"')),null===t&&(44===input.charCodeAt(pos)?(t=",",pos++):(t=null,0===reportFailures&&matchFailed('","')),null===t&&(41===input.charCodeAt(pos)?(t=")",pos++):(t=null,0===reportFailures&&matchFailed('")"')),null===t&&(e=pos,reportFailures++,t=parse_operator(),reportFailures--,null!==t?(t="",pos=e):t=null,null===t&&(e=pos,reportFailures++,input.length>pos?(t=input.charAt(pos),pos++):(t=null,0===reportFailures&&matchFailed("any character")),reportFailures--,null===t?t="":(t=null,pos=e)))))),t}function parse_rollGroup(){var t,e,r,n,i,s,o,l;return o=pos,l=pos,123===input.charCodeAt(pos)?(t="{",pos++):(t=null,0===reportFailures&&matchFailed('"{"')),null!==t&&null!==(e=parse__())&&null!==(r=parse_rollGroupExpression())&&null!==(n=parse__())?(125===input.charCodeAt(pos)?(i="}",pos++):(i=null,0===reportFailures&&matchFailed('"}"')),null!==i&&null!==(s=null!==(s=parse_groupMods())?s:"")?t=[t,e,r,n,i,s]:(t=null,pos=l)):(t=null,pos=l),null!==t&&(t=new GroupExpression(t[2],t[5])),null===t&&(pos=o),t}function parse_rollGroupExpression(){var t,e,r,n,i,s,o,l,a;return s=pos,o=pos,null===(t=parse_rollExpression())&&(t=parse_rollGroup()),null!==t&&null!==(e=parse__())?(44===input.charCodeAt(pos)?(r=",",pos++):(r=null,0===reportFailures&&matchFailed('","')),null!==r&&null!==(n=parse__())&&null!==(i=parse_rollGroupExpression())?t=[t,e,r,n,i]:(t=null,pos=o)):(t=null,pos=o),null!==t&&(l=t[0],a=t[4],Array.isArray(l)||(l=[l]),t=""!==a?[l].concat(a):l),null===t&&(pos=s),null===t&&(s=pos,null===(t=parse_rollExpression())&&(t=parse_rollGroup()),null!==t&&(t=[t]),null===t&&(pos=s)),t}function parse_labelAwareRollOperator(){var t,e,r,n,i;if(n=pos,i=pos,null!==(t=parse_rollOperator())){for(e=[],null===(r=parse_rollOperator())&&(r=parse_inlineLabelWithSpace());null!==r;)e.push(r),null===(r=parse_rollOperator())&&(r=parse_inlineLabelWithSpace());null!==e?t=[t,e]:(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=function(t,e,r){for(var n=e,i=0;i<r.length;i++)n=mergeExpressions(n,r[i]);return n}(0,t[0],t[1])),null===t&&(pos=n),null===t&&(n=pos,i=pos,null!==(t=parse_inlineLabelWithSpace())&&null!==(e=parse_labelAwareRollOperator())?t=[t,e]:(t=null,pos=i),null!==t&&(t=mergeExpressions(t[0],t[1])),null===t&&(pos=n)),t}function parse_rollOperator(){var t,e,r,n,i,s,o,l,a;return l=pos,a=pos,null!==(t=parse__())&&null!==(e=parse_operator())&&null!==(r=parse__())&&null!==(n=parse_mathExpressionPrimary())&&null!==(i=parse__())&&null!==(s=parse_rollOperator())&&null!==(o=parse__())?t=[t,e,r,n,i,s,o]:(t=null,pos=a),null!==t&&(t=t[1]+t[3]+t[5]),null===t&&(pos=l),null===t&&(l=pos,a=pos,null!==(t=parse__())&&null!==(e=parse_operator())&&null!==(r=parse__())?t=[t,e,r]:(t=null,pos=a),null!==t&&(t=t[1]),null===t&&(pos=l)),t}function parse_fullRoll(){var t,e,r,n,i,s,o;return n=pos,i=pos,null!==(t=parse_coreRoll())&&null!==(e=null!==(e=parse_rollMods())?e:"")?t=[t,e]:(t=null,pos=i),null!==t&&(s=t[0],""!==(o=t[1])&&(s.mods=o),t=s),null===t&&(pos=n),null===t&&(n=pos,i=pos,null!==(t=parse_numberOfDice())?("t"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"t"')),null!==e&&null!==(r=parse_inlineLabel())?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=new TableRollExpression(t[0],t[2].text)),null===t&&(pos=n)),t}function parse_coreRoll(){var t,e,r,n,i;return n=pos,i=pos,null!==(t=parse_numberOfDice())?("d"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"d"')),null!==e?("f"===input.substr(pos,1).toLowerCase()?(r=input.substr(pos,1),pos++):(r=null,0===reportFailures&&matchFailed('"f"')),null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=new FateRollExpression(t[0])),null===t&&(pos=n),null===t&&(n=pos,i=pos,null!==(t=parse_numberOfDice())?("d"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"d"')),null!==e&&null!==(r=parse_numberOfSides())?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=new RollExpression(t[0],t[2])),null===t&&(pos=n)),t}function parse_numberOfDice(){var result0,result1,result2,result3,result4,pos0,pos1;return result0=parse_integer(),null===result0&&(pos0=pos,pos1=pos,40===input.charCodeAt(pos)?(result0="(",pos++):(result0=null,0===reportFailures&&matchFailed('"("')),null!==result0?(result1=parse__(),null!==result1?(result2=parse_mathExpression(),null!==result2?(result3=parse__(),null!==result3?(41===input.charCodeAt(pos)?(result4=")",pos++):(result4=null,0===reportFailures&&matchFailed('")"')),null!==result4?result0=[result0,result1,result2,result3,result4]:(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,expr){return Math.round(eval("("+expr+")"))}(pos0,result0[2])),null===result0&&(pos=pos0),null===result0&&(pos0=pos,result0="",null!==result0&&(result0=1),null===result0&&(pos=pos0))),result0}function parse_numberOfSides(){var result0,result1,result2,result3,result4,pos0,pos1;return result0=parse_integer(),null===result0&&(pos0=pos,pos1=pos,40===input.charCodeAt(pos)?(result0="(",pos++):(result0=null,0===reportFailures&&matchFailed('"("')),null!==result0?(result1=parse__(),null!==result1?(result2=parse_mathExpression(),null!==result2?(result3=parse__(),null!==result3?(41===input.charCodeAt(pos)?(result4=")",pos++):(result4=null,0===reportFailures&&matchFailed('")"')),null!==result4?result0=[result0,result1,result2,result3,result4]:(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,expr){return Math.round(eval("("+expr+")"))}(pos0,result0[2])),null===result0&&(pos=pos0),null===result0&&(pos0=pos,"f"===input.substr(pos,1).toLowerCase()?(result0=input.substr(pos,1),pos++):(result0=null,0===reportFailures&&matchFailed('"f"')),null!==result0&&(result0="F"),null===result0&&(pos=pos0))),result0}function parse_groupMods(){var t,e,r,n,i;if(n=pos,i=pos,null===(t=parse_keepMod())&&null===(t=parse_dropMod())&&null===(t=parse_multipleMod())&&null===(t=parse_matchTotalMod())&&null===(t=parse_matchMod())&&(t=parse_successMod()),null!==t){for(e=[],r=parse_groupMods();null!==r;)e.push(r),r=parse_groupMods();null!==e?t=[t,e]:(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=processMods(t[0],t[1])),null===t&&(pos=n),t}function parse_rollMods(){var t,e,r,n,i;if(n=pos,i=pos,null===(t=parse_compoundingMod())&&null===(t=parse_penetratingMod())&&null===(t=parse_explodingMod())&&null===(t=parse_keepMod())&&null===(t=parse_dropMod())&&null===(t=parse_rerollOnceMod())&&null===(t=parse_rerollMod())&&null===(t=parse_customCritMod())&&null===(t=parse_customFumbleMod())&&null===(t=parse_sortMod())&&null===(t=parse_matchTotalMod())&&null===(t=parse_matchMod())&&(t=parse_successMod()),null!==t){for(e=[],r=parse_rollMods();null!==r;)e.push(r),r=parse_rollMods();null!==e?t=[t,e]:(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=processMods(t[0],t[1])),null===t&&(pos=n),t}function parse_explodingMod(){var t,e,r,n;return r=pos,n=pos,33===input.charCodeAt(pos)?(t="!",pos++):(t=null,0===reportFailures&&matchFailed('"!"')),null!==t&&null!==(e=null!==(e=parse_comparisonPoint())?e:"")?t=[t,e]:(t=null,pos=n),null!==t&&(t={exploding:t[1]}),null===t&&(pos=r),t}function parse_compoundingMod(){var t,e,r,n;return r=pos,n=pos,"!!"===input.substr(pos,2)?(t="!!",pos+=2):(t=null,0===reportFailures&&matchFailed('"!!"')),null!==t&&null!==(e=null!==(e=parse_comparisonPoint())?e:"")?t=[t,e]:(t=null,pos=n),null!==t&&(t={compounding:t[1]}),null===t&&(pos=r),t}function parse_penetratingMod(){var t,e,r,n,i;return n=pos,i=pos,33===input.charCodeAt(pos)?(t="!",pos++):(t=null,0===reportFailures&&matchFailed('"!"')),null!==t?("p"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"p"')),null!==e&&null!==(r=null!==(r=parse_comparisonPoint())?r:"")?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(t={penetrating:t[2]}),null===t&&(pos=n),t}function parse_keepMod(){var t,e,r,n,i,s,o;return n=pos,i=pos,"k"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"k"')),null!==t?(/^['h'|'l']/i.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("['h'|'l']i")),null!==(e=null!==e?e:"")&&null!==(r=parse_integer())?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(s=t[1],o=t[2],t={keep:{end:s.toLowerCase()||"h",count:o}}),null===t&&(pos=n),t}function parse_dropMod(){var t,e,r,n,i,s,o;return n=pos,i=pos,"d"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"d"')),null!==t?(/^['h'|'l']/i.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("['h'|'l']i")),null!==(e=null!==e?e:"")&&null!==(r=parse_integer())?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(s=t[1],o=t[2],t={drop:{end:s.toLowerCase()||"l",count:o}}),null===t&&(pos=n),t}function parse_customCritMod(){var t,e,r,n,i,s,o,l;return n=pos,i=pos,"cs"===input.substr(pos,2).toLowerCase()?(t=input.substr(pos,2),pos+=2):(t=null,0===reportFailures&&matchFailed('"cs"')),null!==t&&null!==(e=null!==(e=parse_comparisonPoint())?e:"")&&null!==(r=null!==(r=parse_customCritMod())?r:"")?t=[t,e,r]:(t=null,pos=i),null!==t&&(s=t[1],o=t[2],l={customCrit:""!==s?[s]:[{}]},""!==o&&(l.customCrit=l.customCrit.concat(o.customCrit)),t=l),null===t&&(pos=n),t}function parse_customFumbleMod(){var t,e,r,n,i,s,o,l;return n=pos,i=pos,"cf"===input.substr(pos,2).toLowerCase()?(t=input.substr(pos,2),pos+=2):(t=null,0===reportFailures&&matchFailed('"cf"')),null!==t&&null!==(e=null!==(e=parse_comparisonPoint())?e:"")&&null!==(r=null!==(r=parse_customFumbleMod())?r:"")?t=[t,e,r]:(t=null,pos=i),null!==t&&(s=t[1],o=t[2],l={customFumble:""!==s?[s]:[{}]},""!==o&&(l.customFumble=l.customFumble.concat(o.customFumble)),t=l),null===t&&(pos=n),t}function parse_rerollMod(){var t,e,r,n,i,s,o,l;return n=pos,i=pos,"r"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"r"')),null!==t&&null!==(e=null!==(e=parse_comparisonPoint())?e:"")&&null!==(r=null!==(r=parse_rerollMod())?r:"")?t=[t,e,r]:(t=null,pos=i),null!==t&&(s=t[1],o=t[2],l={reroll:""!==s?[s]:[{}]},""!==o&&(l.reroll=l.reroll.concat(o.reroll)),t=l),null===t&&(pos=n),t}function parse_rerollOnceMod(){var t,e,r,n,i,s,o,l;return n=pos,i=pos,"ro"===input.substr(pos,2).toLowerCase()?(t=input.substr(pos,2),pos+=2):(t=null,0===reportFailures&&matchFailed('"ro"')),null!==t&&null!==(e=null!==(e=parse_comparisonPoint())?e:"")&&null!==(r=null!==(r=parse_rerollMod())?r:"")?t=[t,e,r]:(t=null,pos=i),null!==t&&(s=t[1],o=t[2],l={reroll:""!==s?[s]:[{}]},""!==o&&(l.reroll=l.reroll.concat(o.reroll)),l.reroll&&l.reroll[0]&&(l.reroll[0].maxrerolls=1),t=l),null===t&&(pos=n),t}function parse_sortMod(){var t,e,r,n;return r=pos,n=pos,"s"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"s"')),null!==t?(/^['a'|'d']/i.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("['a'|'d']i")),null!==(e=null!==e?e:"")?t=[t,e]:(t=null,pos=n)):(t=null,pos=n),null!==t&&(t={sort:{order:t[1].toLowerCase()||"a"}}),null===t&&(pos=r),t}function parse_floorMod(){var t,e;return e=pos,"flr"===input.substr(pos,3)?(t="flr",pos+=3):(t=null,0===reportFailures&&matchFailed('"flr"')),null!==t&&(t={round:{type:"floor"}}),null===t&&(pos=e),t}function parse_multipleMod(){var t,e,r,n;return r=pos,n=pos,"x"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"x"')),null!==t&&null!==(e=parse_integer())?t=[t,e]:(t=null,pos=n),null!==t&&(t={multiple:{times:t[1]}}),null===t&&(pos=r),t}function parse_successMod(){var t,e,r,n,i,s,o,l,a;return n=pos,i=pos,null!==(t=parse_comparisonPoint())?(s=pos,"f"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"f"')),null!==e&&null!==(r=parse_comparisonPoint())?e=[e,r]:(e=null,pos=s),null!==(e=null!==e?e:"")?t=[t,e]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(o=t[0],l=t[1],a={success:o},""!==l&&(a.failure=l[1]),t=a),null===t&&(pos=n),t}function parse_matchMod(){var t,e,r,n,i,s,o,l;return n=pos,i=pos,109===input.charCodeAt(pos)?(t="m",pos++):(t=null,0===reportFailures&&matchFailed('"m"')),null!==t&&null!==(e=parse_matchThreshold())&&null!==(r=null!==(r=parse_comparisonPoint())?r:"")?t=[t,e,r]:(t=null,pos=i),null!==t&&(s=t[1],o=t[2],(l={match:""!==o?o:{}}).match.threshold=s,t=l),null===t&&(pos=n),t}function parse_matchTotalMod(){var t,e,r,n,i,s,o,l;return n=pos,i=pos,"mt"===input.substr(pos,2)?(t="mt",pos+=2):(t=null,0===reportFailures&&matchFailed('"mt"')),null!==t&&null!==(e=parse_matchThreshold())&&null!==(r=null!==(r=parse_comparisonPoint())?r:"")?t=[t,e,r]:(t=null,pos=i),null!==t&&(s=t[1],o=t[2],(l={match:""!==o?o:{}}).match.threshold=s,l.match.total=!0,t=l),null===t&&(pos=n),t}function parse_matchThreshold(){var t,e,r,n;for(r=pos,t=[],/^[0-9]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[0-9]"));null!==e;)t.push(e),/^[0-9]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[0-9]"));return null!==t&&(t=(n=t)&&n!=[]&&parseInt(n.join(""),10)>2?parseInt(n.join(""),10):2),null===t&&(pos=r),t}function parse_comparisonPoint(){var t,e,r,n,i;return r=pos,n=pos,null!==(t=null!==(t=parse_comparison())?t:"")&&null!==(e=parse_integer())?t=[t,e]:(t=null,pos=n),null!==t&&(t={comp:(""==(i=t[0])?"=":i)+"=",point:t[1]}),null===t&&(pos=r),t}function parse_comparison(){var t;return/^[>|<|=]/.test(input.charAt(pos))?(t=input.charAt(pos),pos++):(t=null,0===reportFailures&&matchFailed("[>|<|=]")),t}function parse_mathExpression(){var t,e,r,n,i,s,o,l,a;return l=pos,a=pos,null!==(t=parse__())&&null!==(e=parse_mathExpressionPrimary())&&null!==(r=parse__())&&null!==(n=parse_operator())&&null!==(i=parse__())&&null!==(s=parse_mathExpression())&&null!==(o=parse__())?t=[t,e,r,n,i,s,o]:(t=null,pos=a),null!==t&&(t=t[1]+t[3]+t[5]),null===t&&(pos=l),null===t&&(l=pos,a=pos,null!==(t=parse__())&&null!==(e=parse_mathExpressionPrimary())&&null!==(r=parse__())?t=[t,e,r]:(t=null,pos=a),null!==t&&(t=t[1]),null===t&&(pos=l)),t}function parse_mathExpressionPrimary(){var t,e,r,n,i,s,o;return s=pos,o=pos,null!==(t=parse__())&&null!==(e=parse_number())&&null!==(r=parse__())?t=[t,e,r]:(t=null,pos=o),null!==t&&(t=t[1]),null===t&&(pos=s),null===t&&(s=pos,o=pos,40===input.charCodeAt(pos)?(t="(",pos++):(t=null,0===reportFailures&&matchFailed('"("')),null!==t&&null!==(e=parse__())&&null!==(r=parse_mathExpression())&&null!==(n=parse__())?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,r,n,i]:(t=null,pos=o)):(t=null,pos=o),null!==t&&(t="("+t[2]+")"),null===t&&(pos=s)),t}function parse_inlineLabelWithSpace(){var t,e,r,n,i;return n=pos,i=pos,null!==(t=parse__())&&null!==(e=parse_inlineLabel())&&null!==(r=parse__())?t=[t,e,r]:(t=null,pos=i),null!==t&&(t=t[1]),null===t&&(pos=n),t}function parse_inlineLabel(){var t,e,r,n,i;if(n=pos,i=pos,91===input.charCodeAt(pos)?(t="[",pos++):(t=null,0===reportFailures&&matchFailed('"["')),null!==t){for(e=[],
/^[^\]]/.test(input.charAt(pos))?(r=input.charAt(pos),pos++):(r=null,0===reportFailures&&matchFailed("[^\\]]"));null!==r;)e.push(r),/^[^\]]/.test(input.charAt(pos))?(r=input.charAt(pos),pos++):(r=null,0===reportFailures&&matchFailed("[^\\]]"));null!==e?(93===input.charCodeAt(pos)?(r="]",pos++):(r=null,0===reportFailures&&matchFailed('"]"')),null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=new Label(t[1].join(""))),null===t&&(pos=n),t}function parse_operator(){var t;return/^[+|\-|*|\/|%]/.test(input.charAt(pos))?(t=input.charAt(pos),pos++):(t=null,0===reportFailures&&matchFailed("[+|\\-|*|\\/|%]")),t}function parse_number(){var t;return null===(t=parse_exponent())&&null===(t=parse_float())&&(t=parse_signedInteger()),t}function parse_integer(){var t,e,r;if(r=pos,/^[0-9]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[0-9]")),null!==e)for(t=[];null!==e;)t.push(e),/^[0-9]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[0-9]"));else t=null;return null!==t&&(t=parseInt(t.join(""),10)),null===t&&(pos=r),t}function parse_signedInteger(){var t,e,r,n,i,s;return r=pos,n=pos,/^[+|\-]/.test(input.charAt(pos))?(t=input.charAt(pos),pos++):(t=null,0===reportFailures&&matchFailed("[+|\\-]")),null!==(t=null!==t?t:"")&&null!==(e=parse_integer())?t=[t,e]:(t=null,pos=n),null!==t&&(i=t[0],s=t[1],t="-"==i?-1*s:s),null===t&&(pos=r),t}function parse_float(){var t,e,r,n,i,s,o,l;if(i=pos,s=pos,null!==(t=null!==(t=parse_signedInteger())?t:""))if(46===input.charCodeAt(pos)?(e=".",pos++):(e=null,0===reportFailures&&matchFailed('"."')),null!==e){if(/^[0-9]/.test(input.charAt(pos))?(n=input.charAt(pos),pos++):(n=null,0===reportFailures&&matchFailed("[0-9]")),null!==n)for(r=[];null!==n;)r.push(n),/^[0-9]/.test(input.charAt(pos))?(n=input.charAt(pos),pos++):(n=null,0===reportFailures&&matchFailed("[0-9]"));else r=null;null!==r?t=[t,e,r]:(t=null,pos=s)}else t=null,pos=s;else t=null,pos=s;return null!==t&&(o=t[0],l=t[2],t=0===o&&1/o<0?-1*parseFloat(o+"."+l.join("")):parseFloat(o+"."+l.join(""))),null===t&&(pos=i),t}function parse_exponent(){var t,e,r,n,i,s,o,l,a,u;return s=pos,o=pos,null!==(t=null!==(t=parse_signedInteger())?t:"")?(46===input.charCodeAt(pos)?(e=".",pos++):(e=null,0===reportFailures&&matchFailed('"."')),null!==e&&null!==(r=parse_integer())?(101===input.charCodeAt(pos)?(n="e",pos++):(n=null,0===reportFailures&&matchFailed('"e"')),null!==n&&null!==(i=parse_signedInteger())?t=[t,e,r,n,i]:(t=null,pos=o)):(t=null,pos=o)):(t=null,pos=o),null!==t&&(l=t[0],a=t[2],u=t[4],t=parseFloat(l+"."+a+"e"+u)),null===t&&(pos=s),null===t&&(s=pos,o=pos,null!==(t=parse_signedInteger())?(101===input.charCodeAt(pos)?(e="e",pos++):(e=null,0===reportFailures&&matchFailed('"e"')),null!==e&&null!==(r=parse_signedInteger())?t=[t,e,r]:(t=null,pos=o)):(t=null,pos=o),null!==t&&(t=function(t,e,r){return parseFloat(e+"e"+r)}(0,t[0],t[2])),null===t&&(pos=s)),t}function parse__(){var t,e,r;for(r=pos,t=[],/^[ |\t]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[ |\\t]"));null!==e;)t.push(e),/^[ |\t]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[ |\\t]"));return null!==t&&(t=t.join("")),null===t&&(pos=r),t}function parse___(){var t,e,r;if(r=pos,/^[ |\t]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[ |\\t]")),null!==e)for(t=[];null!==e;)t.push(e),/^[ |\t]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[ |\\t]"));else t=null;return null!==t&&(t=t.join("")),null===t&&(pos=r),t}function cleanupExpected(t){t.sort();for(var e=null,r=[],n=0;n<t.length;n++)t[n]!==e&&(r.push(t[n]),e=t[n]);return r}function computeErrorPosition(){for(var t=1,e=1,r=!1,n=0;n<Math.max(pos,rightmostFailuresPos);n++){var i=input.charAt(n);"\n"===i?(r||t++,e=1,r=!1):"\r"===i||"\u2028"===i||"\u2029"===i?(t++,e=1,r=!0):(e++,r=!1)}return{line:t,column:e}}function log(t){console.log(t)}function MathExpression(t){this.type=d20.dice.TYPE_MATH_EXPR,this.expr=t!=undefined?t:""}function RollExpression(t,e){this.type=d20.dice.TYPE_ROLL_EXPR,this.dice=t,this.sides=e,this.mods={}}function FateRollExpression(t){this.type=d20.dice.TYPE_ROLL_EXPR,this.dice=t,this.fate=!0,this.mods={}}function TableRollExpression(t,e){this.type=d20.dice.TYPE_ROLL_EXPR,this.dice=t,this.table=e,this.mods={}}function GroupExpression(t,e){this.type=d20.dice.TYPE_GROUP_EXPR,this.rolls=t,this.mods=e||{}}function Label(t){this.type=d20.dice.TYPE_LABEL,this.text=t}function Comment(t){this.type=d20.dice.TYPE_COMMENT,this.text=t}function mergeExpressions(t,e){if("string"==typeof t){if(0==t.length)return e;t=new MathExpression(t)}if("string"==typeof e){if(0==e.length)return t;e=new MathExpression(e)}if(Array.isArray(t)&&Array.isArray(e)){if(t[t.length-1].type==d20.dice.TYPE_MATH_EXPR&&e[0].type==d20.dice.TYPE_MATH_EXPR){var r=t.pop();e[0].expr=r.expr+e[0].expr}return t.concat(e)}return Array.isArray(t)?(t[t.length-1].type==d20.dice.TYPE_MATH_EXPR&&e.type==d20.dice.TYPE_MATH_EXPR?t[t.length-1].expr+=e.expr:t.push(e),t):Array.isArray(e)?(e[0].type==d20.dice.TYPE_MATH_EXPR&&t.type==d20.dice.TYPE_MATH_EXPR?e[0].expr=t.expr+e[0].expr:e.unshift(t),e):t.type==d20.dice.TYPE_MATH_EXPR&&e.type==d20.dice.TYPE_MATH_EXPR?(t.expr+=e.expr,t):[t,e]}function processMods(t,e){var r=t;if(e.length>0)for(var n in e[0]){if(r[n]!=undefined)throw{message:"'"+n+"' roll modifier can only be specified once"};r[n]=e[0][n]}return r}var parseFunctions={start:parse_start,rollExpression:parse_rollExpression,rollExpressionPrimary:parse_rollExpressionPrimary,validRollSuffix:parse_validRollSuffix,rollGroup:parse_rollGroup,rollGroupExpression:parse_rollGroupExpression,labelAwareRollOperator:parse_labelAwareRollOperator,rollOperator:parse_rollOperator,fullRoll:parse_fullRoll,coreRoll:parse_coreRoll,numberOfDice:parse_numberOfDice,numberOfSides:parse_numberOfSides,groupMods:parse_groupMods,rollMods:parse_rollMods,explodingMod:parse_explodingMod,compoundingMod:parse_compoundingMod,penetratingMod:parse_penetratingMod,keepMod:parse_keepMod,dropMod:parse_dropMod,customCritMod:parse_customCritMod,customFumbleMod:parse_customFumbleMod,rerollMod:parse_rerollMod,rerollOnceMod:parse_rerollOnceMod,sortMod:parse_sortMod,floorMod:parse_floorMod,multipleMod:parse_multipleMod,successMod:parse_successMod,matchMod:parse_matchMod,matchTotalMod:parse_matchTotalMod,matchThreshold:parse_matchThreshold,comparisonPoint:parse_comparisonPoint,comparison:parse_comparison,mathExpression:parse_mathExpression,mathExpressionPrimary:parse_mathExpressionPrimary,inlineLabelWithSpace:parse_inlineLabelWithSpace,inlineLabel:parse_inlineLabel,operator:parse_operator,number:parse_number,integer:parse_integer,signedInteger:parse_signedInteger,float:parse_float,exponent:parse_exponent,_:parse__,__:parse___};if(startRule!==undefined){if(parseFunctions[startRule]===undefined)throw new Error("Invalid rule name: "+quote(startRule)+".")}else startRule="start";var pos=0,reportFailures=0,rightmostFailuresPos=0,rightmostFailuresExpected=[],d20="undefined"!=typeof window&&window.d20!==undefined?window.d20:{};d20.dice==undefined&&(d20.dice=d20.dice||{},d20.dice.TYPE_MATH_EXPR="M",d20.dice.TYPE_ROLL_EXPR="R",d20.dice.TYPE_GROUP_EXPR="G",d20.dice.TYPE_LABEL="L",d20.dice.TYPE_COMMENT="C",d20.dice.TYPE_VALIDATED_ROLLS="V");var result=parseFunctions[startRule]();if(null===result||pos!==input.length){var offset=Math.max(pos,rightmostFailuresPos),found=offset<input.length?input.charAt(offset):null,errorPosition=computeErrorPosition();throw new this.SyntaxError(cleanupExpected(rightmostFailuresExpected),found,offset,errorPosition.line,errorPosition.column)}return result},toSource:function(){return this._source},SyntaxError:function(t,e,r,n,i){function s(t,e){var r;switch(t.length){case 0:r="end of input";break;case 1:r=t[0];break;default:r=t.slice(0,t.length-1).join(", ")+" or "+t[t.length-1]}return"Expected "+r+" but "+(e?quote(e):"end of input")+" found."}this.name="SyntaxError",this.expected=t,this.found=e,this.message=s(t,e),this.offset=r,this.line=n,this.column=i}};return result.SyntaxError.prototype=Error.prototype,result}(),d20.dice_formatter={},d20ext.dice_formatter=d20.dice_formatter,function(){var t=function(){},e=function(r){for(var n="",i=0;i<r.length;i++){if(r[i].type===d20.dice.TYPE_GROUP_EXPR){n+="{<div class='parsegroup'>";for(var s=0;s<r[i].rolls.length;s++)n+="<div class='parsegroupitem ",r[i].results&&r[i].results[s].d&&(n+="dropped"),n+="'>",n+=e(r[i].rolls[s]),s+1<r[i].rolls.length&&(n+=" + "),n+="</div>";n+="</div>}"}if(r[i].type===d20.dice.TYPE_ROLL_EXPR){n+="<div class='dicegrouping' data-groupindex='"+i+"' ",r[i+1]&&r[i+1].type==d20.dice.TYPE_LABEL&&(n+="title='"+r[i+1].text.replace(/'/g,"&apos;")+"'"),n+=">",n+="(";for(var o=0;o<r[i].results.length;o++){n+="<div data-origindex='"+o+"' class='diceroll ",r[i].results.length>50&&(n+="withouticons "),r[i].fate?n+="d6":r[i].table||(n+="d"+r[i].sides),!0===r[i].results[o].d&&(n+=" dropped ");var l=!1,a=!1,u=!1;if(r[i].mods&&r[i].mods.customCrit?_.each(r[i].mods.customCrit,function(t){"<="===t.comp?r[i].results[o].v<=t.point&&(l=!0):">="===t.comp?r[i].results[o].v>=t.point&&(l=!0):"=="===t.comp&&r[i].results[o].v===t.point&&(l=!0)}):r[i].results[o].v===r[i].sides&&(l=!0),l&&(n+=" critsuccess ",t()),r[i].mods&&r[i].mods.customFumble?_.each(r[i].mods.customFumble,function(t){"<="===t.comp?r[i].results[o].v<=t.point&&(a=!0):">="===t.comp?r[i].results[o].v>=t.point&&(a=!0):"=="===t.comp&&r[i].results[o].v===t.point&&(a=!0)}):1===r[i].results[o].v&&!0!==r[i].fate&&(a=!0),a&&(n+=" critfail "),r[i].mods&&r[i].mods.match&&r[i].mods.match.matches[r[i].results[o].v]&&(u=!0),u&&(n+=" match-"+r[i].mods.match.matches[r[i].results[o].v]),n+="'>",u&&(n+="<div class='matchbar' style='border-color:"+r[i].mods.match.matches[r[i].results[o].v]+"'></div>"),n+="<div class='dicon'><div class='didroll'>",!0===r[i].fate)switch(r[i].results[o].v){case 1:n+="+";break;case 0:n+="0";break;case-1:n+="-"}else if(r[i].results[o].tableItem)if(r[i].results[o].tableItem.avatar&&""!==r[i].results[o].tableItem.avatar){const t=r[i].results[o].tableItem.avatar.replace("/med.webm","/thumb.webm"),e=d20ext.utils.strip_tags(r[i].results[o].tableItem.name).replace(/'/g,"&apos;");n+=d20.utils.isVideo(t)?`<video src="${t}" title="${e}" muted autoplay loop />`:`<img src="${t}" title="${e}" />`}else n+=d20ext.utils.strip_tags(r[i].results[o].tableItem.name);else n+=r[i].results[o].v;n+="</div><div class='backing'></div></div>",!0!==r[i].fate&&o+1<r[i].results.length&&(n+="+"),n+="</div>"}n+=")",n+="</div>"}else r[i].type===d20.dice.TYPE_MATH_EXPR&&(n+=r[i].expr)}return n},r=function(t){if(t){for(var e="",n=0;n<t.length;n++){if(t[n].type===d20.dice.TYPE_GROUP_EXPR){e+="{";for(var i=0;i<t[n].rolls.length;i++)e+=r(t[n].rolls[i]),i+1<t[n].rolls.length&&(e+="+");e+="}"}if(t[n].type===d20.dice.TYPE_ROLL_EXPR){var s=t[n].results!==undefined?t[n].results.length:0,o=t[n].mods&&t[n].mods.match&&t[n].mods.match.matches?t[n].mods.match.matches:[];e+="(";for(var l=0;l<s;l++){if(e+="<span class='basicdiceroll",t[n].results[l].d)e+=" dropped";else{var a=!1,u=!1;t[n].mods&&t[n].mods.customCrit?_.each(t[n].mods.customCrit,function(e){"<="===e.comp?t[n].results[l].v<=e.point&&(a=!0):">="===e.comp?t[n].results[l].v>=e.point&&(a=!0):"=="===e.comp&&t[n].results[l].v===e.point&&(a=!0)}):t[n].results[l].v===t[n].sides&&(a=!0),a&&(e+=" critsuccess "),t[n].mods&&t[n].mods.customFumble?_.each(t[n].mods.customFumble,function(e){"<="===e.comp?t[n].results[l].v<=e.point&&(u=!0):">="===e.comp?t[n].results[l].v>=e.point&&(u=!0):"=="===e.comp&&t[n].results[l].v===e.point&&(u=!0)}):1===t[n].results[l].v&&!0!==t[n].fate&&(u=!0),u&&(e+=" critfail ")}if(o!=[]&&o[t[n].results[l].v]&&(e+="' style='color: "+o[t[n].results[l].v]+"'"),e+="'>",!0===t[n].fate)switch(t[n].results[l].v){case 1:e+="+";break;case 0:e+="0";break;case-1:e+="-"}else t[n].results[l].tableItem?e+=d20ext.utils.strip_tags(t[n].results[l].tableItem.name):e+=t[n].results[l].v;e+="</span>",!0!==t[n].fate&&l+1<t[n].results.length&&(e+="+")}e+=")"}else t[n].type===d20.dice.TYPE_MATH_EXPR&&(e+=t[n].expr)}return e}};d20.dice_formatter.checkForCrits=function(t,e){if(!t)return!1;for(var r=!1,n=!1,i=0;i<t.length;i++){if(t[i].type===d20.dice.TYPE_GROUP_EXPR)for(var s=0;s<t[i].rolls.length;s++)!0===d20.dice_formatter.checkForCrits(t[i].rolls[s],e)&&("crit"===e?r=!0:n=!0);if(t[i].type===d20.dice.TYPE_ROLL_EXPR)for(var o=t[i].results!==undefined?t[i].results.length:0,l=0;l<o;l++)!0!==t[i].results[l].d&&(t[i].mods&&t[i].mods.customCrit?_.each(t[i].mods.customCrit,function(e){"<="===e.comp?t[i].results[l].v<=e.point&&(r=!0):">="===e.comp?t[i].results[l].v>=e.point&&(r=!0):"=="===e.comp&&t[i].results[l].v===e.point&&(r=!0)}):t[i].results[l].v===t[i].sides&&(r=!0),t[i].mods&&t[i].mods.customFumble?_.each(t[i].mods.customFumble,function(e){"<="===e.comp?t[i].results[l].v<=e.point&&(n=!0):">="===e.comp?t[i].results[l].v>=e.point&&(n=!0):"=="===e.comp&&t[i].results[l].v===e.point&&(n=!0)}):1===t[i].results[l].v&&!0!==t[i].fate&&(n=!0))}return"crit"===e?r:n},d20.dice_formatter.getHtmlForResult=function(t){var r=e(t.rolls),n=t.total;return t.resultType===d20.dice.ROLL_TYPE_SUCCESS?n=1===n?n+" Success":n+" Successes":t.resultType===d20.dice.ROLL_TYPE_MATCH&&(n=1===n?n+" Match":n+" Matches"),{formula:r,total:n}},d20.dice_formatter.replaceInlineRolls=function(t,e,n){return t=d20.utils.strip_tags(t,n),e.inlinerolls?t=t.replace(/\$\[\[[0-9]+\]\]/g,function(t){var i=t.substring(3,t.length-1),s=e.inlinerolls[parseInt(i,10)];if(!s||!s.results)return"INVALID INLINE ROLL!";s.expression=s.expression.replace("<","&lt;");var o="Rolling "+d20.utils.strip_tags(s.expression,n)+" = ";s.signature&&d20.textchat.verifyRoll(s.rollid,s.results,s.signature)&&(o="<img src='/images/quantumrollwhite.png' class='inlineqroll'> "+o),o+=r(s.results.rolls);var l=s.results.total;try{0==l&&s.results.rolls[0].results[0].tableItem&&(l=d20ext.utils.strip_tags(s.results.rolls[0].results[0].tableItem.name))}catch(h){}var a="<span class='inlinerollresult showtip tipsy-n-right",u=-1!==o.indexOf("critsuccess"),p=-1!==o.indexOf("critfail");return u&&p?a+=" importantroll":u?a+=" fullcrit":p&&(a+=" fullfail"),a+="' title='"+o.replace(/'/g,"&quot;")+"'>"+l+"</span>"}):t};var n={"@":"critsuccess","#":"critfail",_:"dropped"},i=function(t,e){for(var r in n){var s=new RegExp("\\{"+r+"(.+?)"+r+"\\}","g");if(null!=(match=s.exec(t)))return e.push(n[r]),i(match[1],e)}return t};d20.dice_formatter.oldformat=function(t){return t===undefined?"":t.replace(/\{([@#_])(.+?)\1\}/g,function(t,e,r){var s=[n[e]];r=i(r,s);return"<span class='"+s.sort().join(" ")+"'>"+r+"</span>"})}}(),d20.dice_engine=function(seed){function TaskCompletionCallback(t,e,r){var n=0,i=!1;this.taskComplete=function(){if(n==t)throw"All "+n+" tasks have already been completed for: "+r;++n==t&&(i=!0,e())},this.verify=function(){n!=t||i||e()}}function RollResult(t){this.i=t,this.v=0}function GroupResult(t){this.v=t}function ValidatedRollExpression(t,e){this.type=d20.dice.TYPE_VALIDATED_ROLLS,this.rolls=t,this.resultType=e}function ExpressionBuilder(){var expression="",groupMemeberCount=undefined,verifyInGroup=function(){if(groupMemeberCount==undefined)throw"Not currently in a group expression: '"+expression+"'"};this.addMathExpr=function(t){expression+=t},this.startGroup=function(){expression+="(",groupMemeberCount=0,prevResults=[]},this.addGroupValue=function(t){verifyInGroup(),groupMemeberCount>0&&(expression+="+"),expression+=t,groupMemeberCount++},this.addGroupSuccess=function(t,e){this.addGroupValue("("+t+e.comp+e.point+"?1:0)")},this.addGroupFailure=function(t,e){this.addGroupValue("("+t+e.comp+e.point+"?-1:0)")},this.addGroupMatch=function(t,e){var r=e.comp?e.comp:">=",n=e.point?e.point:"0";prevResults.push(t);for(var i={},s=0;s<prevResults.length;s++){var o=prevResults[s];i[o]=i[o]?i[o]+1:1}i[t]===e.threshold&&this.addGroupValue("("+t+r+n+"?1:0)")},this.endGroup=function(){verifyInGroup(),0==groupMemeberCount&&(expression+="0"),expression+=")",groupMemeberCount=undefined,prevResults=[]},this.eval=function(){var result;log(expression);var thisexp=expression;return function(){"use strict";var floor=Math.floor,ceil=Math.ceil,round=Math.round,max=Math.max,min=Math.min,abs=Math.abs;try{result=eval(thisexp)}catch(e){result=0}}(),result}}function showWarning(t,e){var r=window.Campaign.players.get(t.pid);d20.textchat.incoming(!1,{who:"system",type:"system",content:i18n("warning_roll_results_missing_name_number").tranSub(r.get("displayname"),e)}),numBounce=0}d20.dice=d20.dice||{},d20.dice.TYPE_MATH_EXPR="M",d20.dice.TYPE_ROLL_EXPR="R",d20.dice.TYPE_GROUP_EXPR="G",d20.dice.TYPE_LABEL="L",d20.dice.TYPE_COMMENT="C",d20.dice.TYPE_VALIDATED_ROLLS="V",d20.dice.ROLL_TYPE_MATCH="match",d20.dice.ROLL_TYPE_SUCCESS="success",d20.dice.ROLL_TYPE_TABLE="table",d20.dice.ROLL_TYPE_SUM="sum",d20.dice.MATCH_COLORS=["#ee0086","#ff9c00","#688de8","#a6f900","#a909e1","#ff6a00","#07afde","#eefe00"],d20.getTableElementCount==undefined&&(d20.getTableElementCount=function(t){return log("Using fallback getTableElementCount("+t+")"),t.length},d20.getTableElementValue=function(t,e){return log("Using fallback getTableElementValue("+t+", "+e+")"),parseInt(t,10)||0});var MAX_NUM_ROLLS=999,MAX_ROLL=9999999,recentRolls=[];seed==undefined?Math.seedrandom(window.RANDOM_ENTROPY,!0):Math.seedrandom(seed),this.random=Math.randomInt;var othis=this,log=function(){},logerr=function(t){_.isFunction(t)&&(t=t())},fallbackErrorHandler=function(t){throw logerr(t),t},diceRollToString=function(t){var e=t.dice+"d"+t.sides;return t.mods.compounding&&(e+="!!"+comparePointToString(t.mods.compounding)),t.mods.penetrating&&(e+="!p"+comparePointToString(t.mods.penetrating)),t.mods.exploding&&(e+="!"+comparePointToString(t.mods.exploding)),t.mods.keep&&(e+="k","h"!=t.mods.keep.end&&(e+=t.mods.keep.end),e+=t.mods.keep.count),t.mods.drop&&(e+="k","l"!=t.mods.drop.end&&(e+=t.mods.drop.end),e+=t.mods.drop.count),t.mods.reroll&&t.mods.reroll.forEach(function(t){e+="r"+comparePointToString(t)}),t.mods.sort&&(e+="s"+t.mods.sort.order),t.mods.success&&(e+=comparePointToString(t.mods.success,!0)),t.mods.failure&&(e+="f"+comparePointToString(t.mods.failure,!0)),e},comparePointToString=function(t,e){var r="";return t.point&&(("=="!=t.comp||e)&&(r+=t.comp.charAt(0)),r+=t.point),r},validateParseResult=function(t){for(var e=undefined,r=0;r<t.length;r++){if(t[r].type==d20.dice.TYPE_ROLL_EXPR||t[r].type==d20.dice.TYPE_GROUP_EXPR){var n=getRollType(t[r]);if(e==undefined)e=n;else if(e!=n)throw"Cannot mix "+e+" and "+n+" rolls in a single roll expression"}if(t[r].type==d20.dice.TYPE_ROLL_EXPR){if(t[r].fate?t[r].sides=3:t[r].table!=undefined&&(t[r].sides=d20.getTableElementCount(t[r].table)),t[r].fate&&t[r].mods.compounding!=undefined)throw"Compounding FATE dice are not legal, try ! instead of !! for exploding FATE dice";if(t[r].mods&&t[r].mods.exploding!=undefined&&t[r].sides<2)throw"You must roll a d2 or higher to roll exploding dice.";t[r].dice=Math.max(Math.min(t[r].dice,MAX_NUM_ROLLS),0),t[r].sides=Math.max(Math.min(t[r].sides,MAX_ROLL),0)}if(t[r].type==d20.dice.TYPE_GROUP_EXPR){if(1==t[r].rolls.length&&e==d20.dice.ROLL_TYPE_SUCCESS)for(var i=!1,s=0;s<t[r].rolls[0].length;s++)if(t[r].rolls[0][s].type==d20.dice.TYPE_ROLL_EXPR){if(i)throw"Only one roll expression is allowed in a single sub-roll expression success check";i=!0}else if(t[r].rolls[0][s].type==d20.dice.TYPE_GROUP_EXPR)throw t[r].rolls[0][s].type+" expression is not supported in a single sub-roll expression success check";for(var o=undefined,l=0;l<t[r].rolls.length;l++){var a=validateParseResult(t[r].rolls[l]);if(o==undefined)o=a;else if(o!=a)throw"Cannot mix "+o+" and "+a+" rolls in a  roll group"}t[r].resultType=o}}if(e==undefined){if(t[0].type===d20.dice.TYPE_MATH_EXPR)return d20.dice.TYPE_MATH_EXPR;throw"Could not determine result type of: "+JSON.stringify(t)}return e},getRollType=function(t){return t.mods&&t.mods.match!==undefined&&t.mods.match.total!==undefined?d20.dice.ROLL_TYPE_MATCH:t.mods&&t.mods.success!==undefined?d20.dice.ROLL_TYPE_SUCCESS:t.sides!=undefined&&t.sides.type==d20.dice.TYPE_LABEL?d20.dice.ROLL_TYPE_TABLE:d20.dice.ROLL_TYPE_SUM},parseRollString=function(t){log(function(){return"E parseRollString: "+t});var e=d20.DicePEG.parse(t);log(e);var r=new ValidatedRollExpression(e,validateParseResult(e));return log(r),log(JSON.stringify(r)),log(function(){return"L parseRollString: "+r.rolls.length+" expressions from: "+t}),r},initiateRolls=function(t,e,r){for(var n=0;n<t.length;n++)t[n].type==d20.dice.TYPE_ROLL_EXPR?doRolls(t[n],r):t[n].type==d20.dice.TYPE_GROUP_EXPR?initiateGroupRolls(t[n],e,r):r()},initiateGroupRolls=function(t,e,r){for(var n=new TaskCompletionCallback(t.rolls.length,function(){postProcessCompleteGroup(t,e),r()},"groupCompleteCallback"),i=0;i<t.rolls.length;i++)initiateSubGroupRolls(t.rolls[i],t.resultType,n)},initiateSubGroupRolls=function(t,e,r){var n=new TaskCompletionCallback(t.length,function(){r.taskComplete()},"subGroupCompleteCallback");initiateRolls(t,e,function(){n.taskComplete()})},doRolls=function(t,e){log(function(){return diceRollToString(t)+"\t - E doRolls"}),t.results=[];for(var r=new TaskCompletionCallback(t.dice,function(){diceRollCompleteCallback(t),e()},"rollCompleteCallback"),n=function(){r.taskComplete()},i=0;i<t.dice;i++)rollDie(i,t,n);r.verify(),log(function(){return diceRollToString(t)+"\t - L doRolls"})},diceRollCompleteCallback=function(t){if(log(function(){return diceRollToString(t)+"\t - E diceRollCompleteCallback"}),t.results.sort(function(t,e){var r=t.i-e.i;return 0!=r||t.d==e.d?r:t.d?-1:1}),t.results.forEach(function(t){delete t.i}),t.mods&&t.mods.keep!=undefined){var e="l"==t.mods.keep.end?"a":"d",r=sortRolls(t.results,e);keepRolls(r,t.mods.keep.count)}if(t.mods&&t.mods.drop!=undefined){e="l"==t.mods.drop.end?"a":"d",r=sortRolls(t.results,e);dropRolls(r,t.mods.drop.count)}t.mods&&t.mods.sort!=undefined&&(t.results=sortRolls(t.results,t.mods.sort.order)),log(function(){return diceRollToString(t)+"\t - L diceRollCompleteCallback"})},postProcessCompleteGroup=function(t,e){if(log(function(){return"E postProcessCompleteGroup("+e+")"}),t.mods&&t.mods.keep!=undefined&&1==t.rolls.length){var r="l"==t.mods.keep.end?"a":"d",n=buildSubGroupRollsArray(t.rolls[0]);n=sortRolls(n,r),keepRolls(n,t.mods.keep.count),cleanupSubGroupValues(t.rolls[0])}if(t.mods&&t.mods.drop!=undefined&&1==t.rolls.length){r="l"==t.mods.drop.end?"a":"d",n=buildSubGroupRollsArray(t.rolls[0]);n=sortRolls(n,r),dropRolls(n,t.mods.drop.count),cleanupSubGroupValues(t.rolls[0])}if(totalResult(t,e),t.mods&&t.mods.keep!=undefined&&t.rolls.length>1){r="l"==t.mods.keep.end?"a":"d";var i=sortRolls(t.results,r);keepRolls(i,t.mods.keep.count)}if(t.mods&&t.mods.drop!=undefined&&t.rolls.length>1){r="l"==t.mods.drop.end?"a":"d",i=sortRolls(t.results,r);dropRolls(i,t.mods.drop.count)}log(function(){return"L postProcessCompleteGroup"})},buildSubGroupRollsArray=function(t){for(var e=[],r=0;r<t.length;r++)t[r].type==d20.dice.TYPE_ROLL_EXPR?e=e.concat(t[r].results):t[r].type==d20.dice.TYPE_GROUP_EXPR&&(t[r].v=totalResult(t[r],t[r].resultType).eval(),e.push(t[r]));return e},cleanupSubGroupValues=function(t){t.forEach(function(t){t.type==d20.dice.TYPE_GROUP_EXPR&&delete t.v})},keepRolls=function(t,e){for(var r=0,n=0;n<t.length;n++)t[n].d||(r<e?r++:t[n].d=!0)},dropRolls=function(t,e){for(var r=0,n=0;n<t.length&&r<e;n++)t[n].d||(t[n].d=!0,r++)},sortRolls=function(t,e){var r="d"==e?-1:1;return t.slice(0).sort(function(t,e){return(t.v-e.v)*r})},asyncRand=function(t,e,r,n){if(0===t)setTimeout(function(){e(0)},0);else{if("undefined"==typeof Firebase&&d20.tddice&&d20.tddice.canRoll3D()&&!r)return void d20.tddice.roller(t,e,n);if(6===t&&d20.textchat&&d20.textchat.egg_clickhole&&!$("#lightly-overlay").is(":visible")){var i=[["2990",1,4],["2991",1,7],["2992",1,12],["2993",2,7],["2994",2,5],["2995",2,38],["2996",2,11],["2997",3,13],["2998",3,16],["2999",3,6],["3000",3,16],["3001",4,17],["3002",4,18],["3003",4,16],["3004",5,7],["3006",5,24],["3005",5,14],["3007",5,27],["3008",6,7],["3009",6,6],["3010",6,5],["3012",6,10]],s=i[othis.random(i.length)];d20.textchat.sendShout({type:"playclickhole",playerid:window.currentPlayer.id,content:s,time:(new Date).getTime()}),window.fakeLightly&&window.fakeLightly("http://v.theonion.com/onionstudios/video/"+s[0]+"/640.mp4"),setTimeout(function(){e(s[1]),$("#lightly-overlay").hide()},1e3*s[2]+2e3)}else setTimeout(function(){e(othis.random(t)+1)},0)}},compareToPoint=function(value,cp,defaultPoint){if(cp.comp!=undefined){var cpFormula=value+cp.comp+cp.point,cpResult=eval(cpFormula);return cpResult}return value==defaultPoint},rollDie=function(t,e,r,n){var i,s=new RollResult(t);e.results.push(s),i=s,asyncRand(e.sides,function(t){individualRollCallback(e,i,t,r,n)},e.table!==undefined,e.rollid)},individualRollCallback=function(t,e,r,n,i){if(i=i||0,log(function(){return diceRollToString(t)+"\t - E individualRollCallback("+i+") "+r}),t.table!==undefined?(e.tableidx=r-1,e.v+=d20.getTableElementValue(t.table,e.tableidx)):e.v+=r,t.fate&&(e.v-=2),t.mods&&t.mods.penetrating!=undefined&&i>0&&(e.v-=1),i>MAX_NUM_ROLLS)n();else if(t.mods&&t.mods.exploding!=undefined&&compareToPoint(r,t.mods.exploding,t.sides))rollDie(e.i,t,n,i+1);else if(t.mods&&t.mods.compounding!=undefined&&compareToPoint(r,t.mods.compounding,t.sides))asyncRand(t.sides,function(r){individualRollCallback(t,e,r,n,i+1)},t.table!==undefined,t.rollid);else if(t.mods&&t.mods.penetrating!=undefined&&compareToPoint(r,t.mods.penetrating,t.sides))rollDie(e.i,t,n,i+1);else if(t.mods&&t.mods.reroll!=undefined){t.mods.reroll.some(function(s){if(s.maxrerolls)for(var o=0,l=0;l<t.results.length;l++)t.results[l].i===e.i&&!0===t.results[l].d&&o++;return!!compareToPoint(r,s,1)&&(!(s.maxrerolls&&o>=s.maxrerolls)&&(e.d=!0,rollDie(e.i,t,n,i+1),!0))})||n()}else n();log(function(){return diceRollToString(t)+"\t - L individualRollCallback("+i+") "+r})},postProcessCompleteRolls=function(t,e,r){if(log(function(){return"E postProcessCompleteRolls"}),t.type==d20.dice.TYPE_VALIDATED_ROLLS){var n=postProcessCompleteRolls(t.rolls,t.resultType);return t.total=n,n}var i=totalResults(t,e,r);return log(function(){return"L postProcessCompleteRolls - "+i}),i},totalResults=function(t,e,r,n){n=n||new ExpressionBuilder,n=new ExpressionBuilder;for(var i=0;i<t.length;i++)totalResult(t[i],e,r,n);return n.eval()},totalResult=function(t,e,r,n){n=n||new ExpressionBuilder;if(t.type==d20.dice.TYPE_ROLL_EXPR){n.startGroup();for(var i=0;i<t.results.length;i++)t.results[i].d||addResultValue(n,e,t.results[i].v,t);if(n.endGroup(),t.mods.match){var s=[],o={};_.each(t.results,function(t){s.push(t.v)});var l=s.reduce(function(t,e){return t[e]=++t[e]||1,t},{}),a=0;for(var u in l)l[u]>=t.mods.match.threshold&&(!t.mods.match.comp||!t.mods.match.point||">="===t.mods.match.comp&&u>=t.mods.match.point||"<="===t.mods.match.comp&&u<=t.mods.match.point||"=="===t.mods.match.comp&&u==t.mods.match.point)&&(8==a&&(a=0),o[u]=d20.dice.MATCH_COLORS[a],a++);t.mods.match.matches=o}}else if(t.type==d20.dice.TYPE_MATH_EXPR)n.addMathExpr(t.expr);else if(t.type==d20.dice.TYPE_GROUP_EXPR){if(n.startGroup(),!t.d)if(t.results==undefined||r)if(t.results=[],1==t.rolls.length&&e==d20.dice.ROLL_TYPE_SUCCESS){for(var p="",h=undefined,c="",d=0;d<t.rolls[0].length;d++)if(t.rolls[0][d].type==d20.dice.TYPE_ROLL_EXPR){if(h!=undefined)throw"Only one roll expression is allowed in a single sub-roll expression success check";h=t.rolls[0][d]}else if(t.rolls[0][d].type==d20.dice.TYPE_MATH_EXPR)h==undefined?p+=t.rolls[0][d].expr:c+=t.rolls[0][d].expr;else if(t.rolls[0][d].type==d20.dice.TYPE_GROUP_EXPR)throw t.rolls[0][d].type+" expression is not supported in a single sub-roll expression success check";for(d=0;d<h.results.length;d++)if(!h.results[d].d){var f=new ExpressionBuilder;f.startGroup(),f.addMathExpr(p),f.addGroupValue(h.results[d].v),f.addMathExpr(c),f.endGroup(),t.results.push(new GroupResult(f.eval()))}}else for(var g=0;g<t.rolls.length;g++){var m=totalResults(t.rolls[g],t.resultType,r);t.results.push(new GroupResult(m)),addResultValue(n,e,m,t)}else t.results.forEach(function(r){r.d||addResultValue(n,e,r.v,t)});n.endGroup()}return n},addResultValue=function(t,e,r,n){if(e==d20.dice.ROLL_TYPE_SUM)t.addGroupValue(r);else if(e==d20.dice.ROLL_TYPE_SUCCESS)t.addGroupSuccess(r,n.mods.success),n.mods&&n.mods.failure!=undefined&&t.addGroupFailure(r,n.mods.failure);else{if(e!=d20.dice.ROLL_TYPE_MATCH)throw"Unsupported resultType: "+e;t.addGroupMatch(r,n.mods.match)}};this.reprocess=function(t,e,r){r=r||fallbackErrorHandler;try{postProcessCompleteRolls(t,undefined,!0),e(t)}catch(n){r(n)}};var remoteRollQueue=[],remoteRollCallbacks={},performRemoteRoll=function(t,e,r,n,i){remoteRollQueue.push({vre:t,rollid:e,rolltype:r}),remoteRollCallbacks[e]={success:n,error:i},debounced_doRemoteRollRequest()},_doRemoteRollRequest=function(){if(0!==remoteRollQueue.length)if(!window.is_playerapp&&window.currentPlayer.get("tddiceenabled")&&!1===window.currentPlayer.get("disableagency")){if($("#tdagencyoverlay").is(":visible"))return;$("#tdagencyoverlay").show(),numberofdice=remoteRollQueue[0].vre.rolls[0].dice?remoteRollQueue[0].vre.rolls[0].dice:1,d20.tddice.playsound("dicecup",numberofdice);var t={},e=$("#tdagencyoverlay svg line"),r=!1;$("#tdagencyoverlay").on("mousedown",function(n){t.startx=n.clientX/$(window).width(),t.starty=n.clientY/$(window).height(),e.attr("x1",n.clientX).attr("y1",n.clientY).attr("x2",n.clientX).attr("y2",n.clientY),r=!0}),$("#tdagencyoverlay").on("mousemove",function(n){if(r){xdist=Math.abs(t.startx-n.clientX/$(window).width()),ydist=Math.abs(t.starty-n.clientY/$(window).height());var i=Math.sqrt(xdist*xdist+ydist*ydist);i<.2?e.css("stroke","rgb(255,255,255)"):i<.5?e.css("stroke","rgb(245,238,44)"):e.css("stroke","rgb(245,44,44)"),e.attr("x2",n.clientX).attr("y2",n.clientY)}}),$("#tdagencyoverlay").on("mouseup",function(r){$("#tdagencyoverlay").off().hide(),e.attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",0),t.startx?(t.stopx=r.clientX/$(window).width(),t.stopy=r.clientY/$(window).height(),_posthookrollrequest(t)):_posthookrollrequest()})}else setTimeout(function(){_posthookrollrequest()},50)},_posthookrollrequest=function(t){if(0===remoteRollQueue.length)return;var e={cid:window.campaign_storage_path,fbnum:window.FIREBASE_ROOT,authkey:window.GNTKN,pid:window.currentPlayer.id,rolls:remoteRollQueue,use3d:window.is_playerapp?window.currentPlayer.get("apptddiceenabled"):window.currentPlayer.get("tddiceenabled")};if(t){var r={x:t.startx-t.stopx,y:t.starty-t.stopy};mindistance=.01,maxdistance=.3,Math.abs(r.x)<mindistance&&(r.x=r.x<0?-mindistance:mindistance),Math.abs(r.y)<mindistance&&(r.y=r.y<0?-mindistance:mindistance),Math.abs(r.x)>maxdistance&&(r.x=r.x<0?-maxdistance:maxdistance),Math.abs(r.y)>maxdistance&&(r.y=r.y<0?-maxdistance:maxdistance),e.deltas={x:80*r.x*-1,y:80*r.y*1}}else!0===e.use3d&&(e.deltas={x:10*Math.random()-5,y:20});let n="https://dice.roll20.net";"staging"===d20.environment?n="https://app.roll20staging.net":"beta"===d20.environment&&(n="https://app.roll20dev.net"),n="https://dice.roll20.net",$.ajax({url:n+"/doroll",type:"POST",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){for(var e in t)if(remoteRollCallbacks[e]||(remoteRollCallbacks[e]={success:d20.textchat.roll_default_callback,error:d20.textchat.roll_error_callback}),d20.dice_engine.newRoll(e),t[e].error==undefined){var r=JSON.parse(t[e].json);postProcessCompleteRolls(r),remoteRollCallbacks[e].success(r,e,t[e].signature,t[e].tdseed),d20.tutorial&&t[e].shoutjson!==undefined&&d20.tddice.remoteRoll(JSON.parse(t[e].shoutjson))}else remoteRollCallbacks[e].error("There was an error fetching your roll. "+t[e].error)},error:function(){_.each(e.rolls,function(t){var e=t.vre,r=new TaskCompletionCallback(e.rolls.length,function(){postProcessCompleteRolls(e),setTimeout(function(){remoteRollCallbacks[t.rollid].success(e,null,!1)},0)},"wholeRollCompleteCallback");initiateRolls(e.rolls,e.resultType,function(){r.taskComplete()})})}}),remoteRollQueue=[]},numBounce=0,showWarningTH=_.throttle(showWarning,7e3,{leading:!1});d20.dice_engine.handleRollReceived=function(t){-1===recentRolls.indexOf(t.rid)?setTimeout(function(){-1===recentRolls.indexOf(t.rid)?showWarningTH(t,++numBounce):recentRolls.splice(recentRolls.indexOf(t.rid),1)},3e3):recentRolls.splice(recentRolls.indexOf(t.rid),1)},d20.dice_engine.newRoll=function(t){-1===recentRolls.indexOf(t)&&recentRolls.push(t)},this.flushRemoteQueue=function(){
_doRemoteRollRequest()};var debounced_doRemoteRollRequest=_.debounce(_doRemoteRollRequest,100);return this.process=function(t,e,r){r=r||fallbackErrorHandler;try{var n=parseRollString(t);if(0==n.rolls)throw"There were no dice to roll!";var i=!1,s=!1,o=0,l=function(t){if(o++,t!==undefined)for(var e=0;e<t.length;e++)if(t[e].table!==undefined&&(i=!0),"R"===t[e].type&&(s=!0),(!i||!s)&&o<99&&t[e].rolls!==undefined&&t[e].rolls.length>0)for(var r=0;r<t[e].rolls.length;r++)l(t[e].rolls[r])};try{l(n.rolls)}catch(h){}if(l=null,d20.textchat&&d20.textchat.egg_clickhole&&(i=!0),"undefined"==typeof Firebase||!0===i||!1===s){var a=new TaskCompletionCallback(n.rolls.length,function(){postProcessCompleteRolls(n),setTimeout(function(){e(n,null,!1)},0)},"wholeRollCompleteCallback");initiateRolls(n.rolls,n.resultType,function(){a.taskComplete()})}else if("undefined"==typeof $){var u=generateUUID(),p={vre:n,cid:CAMPAIGNID,fbnum:"https://"+FIREBASENUM+".firebaseio.com/",pid:"api",rid:u,use3d:!1,authkey:FIREBASETOKEN,rolltype:d20.textchat.currentRollType};let t="https://dice.roll20.net";"staging"===d20.environment?t="https://app.roll20staging.net":"beta"===d20.environment&&(t="https://app.roll20dev.net"),request.post({url:t+"/doroll",body:p,json:!0,timeout:5e3},function(t,n,i){if(t||200!=n.statusCode||""===i)r("There was an error communicating with the QuantumRoll server.");else{var s=i;if(s.error!==undefined)return void r("There was an error fetching your roll. "+s.error);var o=JSON.parse(s.json);postProcessCompleteRolls(o),e(o,u,s.signature)}})}else{u=generateUUID();performRemoteRoll(n,u,d20.textchat.currentRollType,e,r)}}catch(h){r(h)}},this.handleRollReq=function(t,e){var r=new TaskCompletionCallback(t.rolls.length,function(){try{postProcessCompleteRolls(t)}catch(r){return void e({error:"There was an error processing this roll."})}setTimeout(function(){e(t)},0)},"wholeRollCompleteCallback");try{initiateRolls(t.rolls,t.resultType,function(){r.taskComplete()})}catch(n){e({error:"There was an error processing this roll."})}},this.handleRollString=function(t){var e=parseRollString(t);if(0==e.rolls)throw"There were no dice to roll!";return e},this};